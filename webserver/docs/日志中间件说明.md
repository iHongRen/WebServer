# 日志中间件说明

## 概述

日志中间件提供了HTTP请求的自动日志记录功能，支持多种预定义格式和自定义格式，类似于Express.js的morgan中间件。

## 基本使用

### 快速开始

```typescript
import { WebServer } from './WebServer';

const app = new WebServer();

// 使用默认开发环境格式
app.logger();

// 或者使用特定格式
app.use(Logger.dev());        // 开发环境格式
app.use(Logger.combined());   // 生产环境格式
app.use(Logger.tiny());       // 最简格式
```

### 自定义配置

```typescript
import { Logger, LogFormat } from './middleware';

app.use(Logger.create({
  format: LogFormat.COMBINED,
  skip: (req, res) => req.path.startsWith('/health'),
  stream: {
    write: (message) => {
      // 自定义输出处理
      console.log(`[LOG] ${message.trim()}`);
    }
  }
}));
```

## 日志格式

### 预定义格式

#### 1. DEV (开发环境格式)
```
GET /api/users/123 200 15ms - 156
```
- 包含：方法、URL、状态码、响应时间、响应大小
- 带有颜色标识（状态码颜色区分）
- 适合开发调试

#### 2. TINY (最简格式)
```
GET /api/users/123 200 156 - 15 ms
```
- 最简洁的格式
- 包含基本信息
- 适合简单监控

#### 3. SHORT (简短格式)
```
127.0.0.1 - GET /api/users/123 HTTP/1.1 200 156 - 15 ms
```
- 包含客户端IP
- 包含HTTP版本
- 中等详细程度

#### 4. COMMON (通用格式 - Apache Common Log Format)
```
127.0.0.1 - - [18/Aug/2025:10:30:45 +0800] "GET /api/users/123 HTTP/1.1" 200 156
```
- Apache标准格式
- 包含时间戳
- 适合日志分析工具

#### 5. COMBINED (组合格式 - Apache Combined Log Format)
```
127.0.0.1 - - [18/Aug/2025:10:30:45 +0800] "GET /api/users/123 HTTP/1.1" 200 156 "http://localhost:3000/" "Mozilla/5.0..."
```
- 最详细的格式
- 包含Referer和User-Agent
- 适合生产环境完整日志

### 自定义格式

支持使用占位符创建自定义格式：

```typescript
app.use(Logger.create({
  format: ':method :url :status :response-time ms - :res[content-length] bytes'
}));
```

#### 可用占位符

- `:method` - HTTP方法
- `:url` - 请求URL
- `:status` - 响应状态码
- `:res[content-length]` - 响应内容长度
- `:response-time` - 响应时间（毫秒）
- `:remote-addr` - 客户端IP地址
- `:user-agent` - User-Agent头
- `:referrer` - Referer头
- `:date` - 请求时间戳
- `:http-version` - HTTP版本

## 高级功能

### 条件性日志记录

```typescript
app.use(Logger.create({
  format: LogFormat.DEV,
  skip: (req, res) => {
    // 跳过静态资源
    if (req.path.includes('/static/')) return true;
    // 跳过健康检查
    if (req.path === '/health') return true;
    // 跳过成功的OPTIONS请求
    if (req.method === 'OPTIONS' && res.getStatusCode() < 400) return true;
    return false;
  }
}));
```

### 自定义输出流

```typescript
// 写入文件
const fs = require('fs');
const logStream = fs.createWriteStream('access.log', { flags: 'a' });

app.use(Logger.create({
  format: LogFormat.COMBINED,
  stream: {
    write: (message) => {
      logStream.write(message);
    }
  }
}));

// 发送到远程日志服务
app.use(Logger.create({
  format: LogFormat.COMBINED,
  stream: {
    write: (message) => {
      // 发送到日志服务
      sendToLogService(message);
    }
  }
}));
```

### 环境相关配置

```typescript
const isDevelopment = process.env.NODE_ENV === 'development';

if (isDevelopment) {
  // 开发环境：详细彩色日志
  app.use(Logger.dev());
} else {
  // 生产环境：标准格式，可能写入文件
  app.use(Logger.combined());
}
```

## 性能考虑

### 1. 格式选择
- 开发环境：使用`DEV`或`TINY`格式
- 生产环境：使用`COMBINED`或`COMMON`格式
- 高并发场景：使用`TINY`格式减少开销

### 2. 条件跳过
```typescript
app.use(Logger.create({
  format: LogFormat.TINY,
  skip: (req, res) => {
    // 跳过不重要的请求
    return req.path.startsWith('/static/') || 
           req.path.startsWith('/favicon.ico');
  }
}));
```

### 3. 异步写入
```typescript
const logQueue = [];
const flushInterval = 1000; // 1秒

app.use(Logger.create({
  format: LogFormat.COMBINED,
  stream: {
    write: (message) => {
      logQueue.push(message);
    }
  }
}));

// 定期批量写入
setInterval(() => {
  if (logQueue.length > 0) {
    const logs = logQueue.splice(0);
    // 批量写入文件或发送到日志服务
    batchWriteLogs(logs);
  }
}, flushInterval);
```

## 日志分析

### 常见日志分析工具

1. **ELK Stack** (Elasticsearch, Logstash, Kibana)
2. **Fluentd**
3. **Grafana + Loki**
4. **Splunk**

### 日志格式建议

- **开发环境**：使用`DEV`格式，便于调试
- **测试环境**：使用`SHORT`格式，平衡详细程度和性能
- **生产环境**：使用`COMBINED`格式，便于分析

## 示例输出

### 开发环境示例
```
GET / 200 5ms - 45
POST /api/users 201 23ms - 128
GET /api/users/123 200 8ms - 89
DELETE /api/users/123 204 12ms - 0
GET /nonexistent 404 2ms - 34
POST /api/error 500 15ms - 67
```

### 生产环境示例
```
192.168.1.100 - - [18/Aug/2025:14:30:15 +0800] "GET / HTTP/1.1" 200 45 "https://example.com" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
192.168.1.100 - - [18/Aug/2025:14:30:18 +0800] "POST /api/users HTTP/1.1" 201 128 "https://example.com/admin" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

## 最佳实践

1. **选择合适的格式**：根据环境和需求选择
2. **合理使用跳过条件**：避免记录不必要的请求
3. **考虑性能影响**：高并发时使用简单格式
4. **日志轮转**：定期清理旧日志文件
5. **监控日志大小**：避免日志文件过大
6. **结构化日志**：考虑使用JSON格式便于分析

## 故障排除

### 常见问题

1. **日志不显示**
   - 检查中间件是否正确注册
   - 确认格式配置正确

2. **性能问题**
   - 使用更简单的日志格式
   - 添加跳过条件
   - 考虑异步写入

3. **日志格式错误**
   - 检查自定义格式的占位符
   - 确认所有必需的数据都可用

4. **文件写入失败**
   - 检查文件权限
   - 确认目录存在
   - 处理写入错误