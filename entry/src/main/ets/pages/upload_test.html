<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Chunked Upload Test</title>
        <style>
            body {
                font-family: sans-serif;
                padding: 20px;
            }

            #log {
                border: 1px solid #ccc;
                padding: 10px;
                height: 300px;
                overflow-y: scroll;
                margin-top: 10px;
                font-family: monospace;
                font-size: 12px;
            }

            .progress-container {
                width: 100%;
                background-color: #f3f3f3;
                border: 1px solid #ccc;
                margin-top: 10px;
            }

            .progress-bar {
                width: 0%;
                height: 30px;
                background-color: #4caf50;
                text-align: center;
                line-height: 30px;
                color: white;
            }
        </style>
    </head>
    <body>
        <h1>Chunked Upload Test (Native JS)</h1>

        <input id="file-input" type="file" />
        <button id="upload-button">Upload</button>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div id="log"></div>

        <script>
            const fileInput = document.getElementById('file-input')
            const uploadButton = document.getElementById('upload-button')
            const progressBar = document.getElementById('progress-bar')
            const logDiv = document.getElementById('log')

            function log(message) {
                logDiv.innerHTML += message + '\n'
                logDiv.scrollTop = logDiv.scrollHeight
            }

            uploadButton.addEventListener('click', async () => {
                const file = fileInput.files[0]
                if (!file) {
                    log('Please select a file.')
                    return
                }

                const chunkSize = 1 * 1024 * 1024 // 1MB
                const totalChunks = Math.ceil(file.size / chunkSize)
                const identifier = `test-${file.name}-${file.size}`

                log(`Starting upload for ${file.name}`)
                log(`File size: ${file.size} bytes, Total chunks: ${totalChunks}`)

                let uploadedChunks = 0

                for (let i = 0; i < totalChunks; i++) {
                    const chunkNumber = i + 1
                    const start = i * chunkSize
                    const end = Math.min(start + chunkSize, file.size)
                    const chunk = file.slice(start, end)

                    // Check if chunk exists
                    log(`Checking for chunk #${chunkNumber}...`)
                    const checkUrl = `http://192.168.2.38:8080/upload?flowChunkNumber=${chunkNumber}&flowIdentifier=${identifier}&flowFilename=${file.name}`
                    const checkResponse = await fetch(checkUrl)

                    if (checkResponse.status === 200) {
                        log(`Chunk #${chunkNumber} already exists on server. Skipping.`)
                        uploadedChunks++
                        updateProgress(uploadedChunks, totalChunks)
                        continue
                    }

                    log(`Uploading chunk #${chunkNumber}...`)
                    const formData = new FormData()
                    formData.append('file', chunk, file.name)
                    formData.append('flowChunkNumber', chunkNumber)
                    formData.append('flowTotalChunks', totalChunks)
                    formData.append('flowIdentifier', identifier)
                    formData.append('flowFilename', file.name)
                    formData.append('flowTotalSize', file.size)

                    try {
                        const uploadResponse = await fetch('http://192.168.2.38:8080/upload', {
                            method: 'POST',
                            body: formData
                        })

                        if (uploadResponse.ok) {
                            log(`Chunk #${chunkNumber} uploaded successfully.`)
                            uploadedChunks++
                            updateProgress(uploadedChunks, totalChunks)
                        } else {
                            log(`Error uploading chunk #${chunkNumber}: ${uploadResponse.statusText}`)
                            break // Stop on error
                        }
                    } catch (error) {
                        log(`Network error uploading chunk #${chunkNumber}: ${error.message}`)
                        break // Stop on error
                    }
                }

                if (uploadedChunks === totalChunks) {
                    log('File upload complete!')
                } else {
                    log('File upload failed or was interrupted.')
                }
            })

            function updateProgress(uploaded, total) {
                const percent = Math.floor((uploaded / total) * 100)
                progressBar.style.width = percent + '%'
                progressBar.textContent = percent + '%'
            }
        </script>
    </body>
</html>
