// /**
//  * @fileName : EventExample.ets
//  * @author : @cxy
//  * @date : 2025/10/29
//  * @description : Eventç¤ºä¾‹ - å±•ç¤ºæœåŠ¡å™¨äº‹ä»¶ç³»ç»ŸåŠŸèƒ½
//  */
//
// import { fileIo } from '@kit.CoreFileKit';
// import { common } from '@kit.AbilityKit';
// import {
//   HttpServer,
//   ErrorHandler,
//   ServerInfo,
//   ServerEventType,
//   ServerErrorType,
//   HttpRequest,
//   HttpResponse,
// } from '@cxy/webserver';
//
// /**
//  * äº‹ä»¶é…ç½®æ¥å£
//  */
// interface EventConfig {
//   port: number;
//   staticRoot: string;
//   enableLogging: boolean;
//   enableCors: boolean;
//   eventHistoryLimit: number;
// }
//
// /**
//  * äº‹ä»¶è®°å½•æ¥å£
//  */
// interface EventRecord {
//   id: number;
//   type: 'server' | 'error' | 'client' | 'custom';
//   eventName: string;
//   message: string;
//   data?: any;
//   timestamp: Date;
//   level: 'info' | 'warn' | 'error';
// }
//
// /**
//  * Eventç¤ºä¾‹ç±»
//  * å±•ç¤ºæœåŠ¡å™¨äº‹ä»¶ç³»ç»Ÿçš„å„ç§åŠŸèƒ½
//  */
// export class EventExample {
//   private server: HttpServer | null = null;
//   private serverInfo: ServerInfo | null = null;
//   private isRunning: boolean = false;
//   private config: EventConfig;
//   private context: common.UIAbilityContext;
//   // äº‹ä»¶è®°å½•
//   private eventHistory: EventRecord[] = [];
//   private nextEventId: number = 1;
//   private eventListeners: Map<string, Function[]> = new Map();
//
//   constructor(context: common.UIAbilityContext, config?: Partial<EventConfig>) {
//     this.context = context;
//     this.config = {
//       port: config?.port || 8084,
//       staticRoot: config?.staticRoot || context.filesDir + '/static',
//       enableLogging: config?.enableLogging || true,
//       enableCors: config?.enableCors || true,
//       eventHistoryLimit: config?.eventHistoryLimit || 1000,
//     };
//   }
//
//   /**
//    * è®¾ç½®é™æ€æ–‡ä»¶
//    */
//   public async setupStaticFiles(): Promise<void> {
//     const access = await fileIo.access(this.config.staticRoot);
//     if (!access) {
//       await fileIo.mkdir(this.config.staticRoot);
//     }
//
//     await this.copyStaticFile('event-demo.html');
//     await this.copyStaticFile('event-monitor.html');
//   }
//
//   /**
//    * åˆå§‹åŒ–æœåŠ¡å™¨
//    */
//   public initializeServer(): void {
//     this.server = new HttpServer();
//
//     this.setupEventHandling();
//     this.setupMiddleware();
//     this.setupRoutes();
//     this.setupGlobalErrorHandler();
//   }
//
//   /**
//    * å¯åŠ¨æœåŠ¡å™¨
//    */
//   public async start(): Promise<ServerInfo | null> {
//     try {
//       if (!this.server) {
//         this.initializeServer();
//       }
//
//       if (!this.server) {
//         throw new Error('EventæœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥');
//       }
//
//       const info = await this.server.startServer(this.config.port);
//
//       if (info.address) {
//         this.serverInfo = info;
//         this.isRunning = true;
//
//         console.log('âœ… EventæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
//         console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
//         this.printApiEndpoints(info);
//
//         // è§¦å‘è‡ªå®šä¹‰å¯åŠ¨äº‹ä»¶
//         this.emitCustomEvent('server_ready', {
//           address: info.address,
//           port: info.port,
//           startTime: new Date()
//         });
//
//         return info;
//       } else {
//         throw new Error('æœªèƒ½è·å–æœåŠ¡å™¨åœ°å€');
//       }
//     } catch (error) {
//       console.error('âŒ å¯åŠ¨EventæœåŠ¡å™¨å¤±è´¥:', error);
//       this.isRunning = false;
//       return null;
//     }
//   }
//
//   /**
//    * åœæ­¢æœåŠ¡å™¨
//    */
//   public async stop(): Promise<void> {
//     if (this.server && this.isRunning) {
//       await this.server.stopServer();
//       this.isRunning = false;
//       this.serverInfo = null;
//
//       // è§¦å‘è‡ªå®šä¹‰åœæ­¢äº‹ä»¶
//       this.emitCustomEvent('server_shutdown', {
//         stopTime: new Date(),
//         totalEvents: this.eventHistory.length
//       });
//
//       console.log('ğŸ›‘ EventæœåŠ¡å™¨å·²åœæ­¢');
//     }
//   }
//
//   // Getteræ–¹æ³•
//   public getServerInfo(): ServerInfo | null {
//     return this.serverInfo;
//   }
//
//   public getIsRunning(): boolean {
//     return this.isRunning;
//   }
//
//   public getConfig(): EventConfig {
//     return this.config;
//   }
//
//   public getEventCount(): number {
//     return this.eventHistory.length;
//   }
//
//   /**
//    * å¤åˆ¶é™æ€æ–‡ä»¶
//    */
//   private async copyStaticFile(fileName: string): Promise<void> {
//     try {
//       const buffer = await this.context.resourceManager.getRawFileContent(fileName);
//       const filePath = `${this.config.staticRoot}/${fileName}`;
//
//       const file = await fileIo.open(filePath,
//         fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
//       await fileIo.write(file.fd, buffer.buffer);
//       await fileIo.close(file.fd);
//     } catch (error) {
//       console.warn(`âš ï¸  æ— æ³•å¤åˆ¶æ–‡ä»¶ ${fileName}:`, error);
//     }
//   }
//
//   /**
//    * è®¾ç½®äº‹ä»¶å¤„ç†
//    */
//   private setupEventHandling(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // ç›‘å¬æœåŠ¡å™¨é”™è¯¯äº‹ä»¶
//     this.server.onError((error) => {
//       // this.recordEvent({
//       //   type: 'error',
//       //   eventName: error.type,
//       //   message: error.message,
//       //   data: {
//       //     originalError: error.originalError,
//       //     context: error.context
//       //   },
//       //   level: 'error'
//       // });
//
//       console.error(`ğŸš¨ æœåŠ¡å™¨é”™è¯¯ [${error.type}]: ${JSON.stringify(error.error)}`);
//     });
//
//     // ç›‘å¬æœåŠ¡å™¨äº‹ä»¶
//     Object.values(ServerEventType).forEach(eventType => {
//       this.server!.on(eventType, (event) => {
//         // this.recordEvent({
//         //   type: 'server',
//         //   eventName: eventType,
//         //   data: event.data,
//         //   level: 'info'
//         // });
//
//         console.log(`ğŸ“¡ æœåŠ¡å™¨äº‹ä»¶ [${eventType}]: ${JSON.stringify(event.data)}`);
//       });
//     });
//
//
//   }
//
//   /**
//    * è®°å½•äº‹ä»¶
//    */
//   private recordEvent(eventData: Omit<EventRecord, 'id' | 'timestamp'>): void {
//     const event: EventRecord = {
//       id: this.nextEventId++,
//       timestamp: new Date(),
//       ...eventData
//     };
//
//     this.eventHistory.push(event);
//
//     // é™åˆ¶å†å²è®°å½•æ•°é‡
//     if (this.eventHistory.length > this.config.eventHistoryLimit) {
//       this.eventHistory = this.eventHistory.slice(-this.config.eventHistoryLimit);
//     }
//
//     // è§¦å‘äº‹ä»¶ç›‘å¬å™¨
//     this.triggerEventListeners(event.eventName, event);
//   }
//
//   /**
//    * è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
//    */
//   private emitCustomEvent(eventName: string, data?: any): void {
//     this.recordEvent({
//       type: 'custom',
//       eventName,
//       message: `è‡ªå®šä¹‰äº‹ä»¶: ${eventName}`,
//       data,
//       level: 'info'
//     });
//   }
//
//   /**
//    * æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
//    */
//   private addEventListener(eventName: string, listener: Function): void {
//     if (!this.eventListeners.has(eventName)) {
//       this.eventListeners.set(eventName, []);
//     }
//     this.eventListeners.get(eventName)!.push(listener);
//   }
//
//   /**
//    * è§¦å‘äº‹ä»¶ç›‘å¬å™¨
//    */
//   private triggerEventListeners(eventName: string, event: EventRecord): void {
//     const listeners = this.eventListeners.get(eventName) || [];
//     listeners.forEach(listener => {
//       try {
//         listener(event);
//       } catch (error) {
//         console.error(`äº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œé”™è¯¯ [${eventName}]:`, error);
//       }
//     });
//   }
//
//   /**
//    * é…ç½®ä¸­é—´ä»¶
//    */
//   private setupMiddleware(): void {
//     if (!this.server) {
//       return;
//     }
//
//     if (this.config.enableLogging) {
//       this.server.logger({
//         format: 'dev',
//         stream: (log: string) => {
//           console.log(`ğŸ“ ${log}`);
//           // è®°å½•æ—¥å¿—äº‹ä»¶
//           this.recordEvent({
//             type: 'server',
//             eventName: 'request_log',
//             message: log,
//             level: 'info'
//           });
//         }
//       });
//     }
//
//     if (this.config.enableCors) {
//       this.server.cors({ origin: '*' });
//     }
//
//     this.server.auto();
//     this.server.serveStatic(this.config.staticRoot);
//   }
//
//   /**
//    * é…ç½®è·¯ç”±
//    */
//   private setupRoutes(): void {
//     this.setupEventRoutes();
//     this.setupMonitorRoutes();
//     this.setupTriggerRoutes();
//   }
//
//   /**
//    * äº‹ä»¶æŸ¥è¯¢è·¯ç”±
//    */
//   private setupEventRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // è·å–äº‹ä»¶å†å²
//     this.server.get('/api/events', (req: HttpRequest, res: HttpResponse) => {
//       const limit = parseInt(req.query.get('limit') || '50');
//       const offset = parseInt(req.query.get('offset') || '0');
//       const type = req.query.get('type');
//       const level = req.query.get('level');
//
//       let filteredEvents = this.eventHistory;
//
//       if (type) {
//         filteredEvents = filteredEvents.filter(event => event.type === type);
//       }
//
//       if (level) {
//         filteredEvents = filteredEvents.filter(event => event.level === level);
//       }
//
//       const events = filteredEvents
//         .slice(offset, offset + limit)
//         .reverse(); // æœ€æ–°çš„åœ¨å‰
//
//       res.json({
//         events,
//         total: filteredEvents.length,
//         limit,
//         offset,
//         filters: { type, level }
//       });
//     });
//
//     // è·å–ç‰¹å®šäº‹ä»¶
//     this.server.get('/api/events/:id', (req: HttpRequest, res: HttpResponse) => {
//       const id = parseInt(req.params['id']);
//       const event = this.eventHistory.find(e => e.id === id);
//
//       if (event) {
//         res.json({ event });
//       } else {
//         res.status(404).json({ error: 'Event not found', id });
//       }
//     });
//
//     // è·å–äº‹ä»¶ç»Ÿè®¡
//     this.server.get('/api/events/stats', (req: HttpRequest, res: HttpResponse) => {
//       // const stats = this.analyzeEvents();
//
//       res.json({
//         // totalEvents: this.eventHistory.length,
//         // byType: stats.byType,
//         // byLevel: stats.byLevel,
//         // recentActivity: stats.recentActivity,
//         // topEvents: stats.topEvents
//       });
//     });
//
//     // æ¸…é™¤äº‹ä»¶å†å²
//     this.server.delete('/api/events', (req: HttpRequest, res: HttpResponse) => {
//       const count = this.eventHistory.length;
//       this.eventHistory = [];
//       this.nextEventId = 1;
//
//       this.emitCustomEvent('events_cleared', { clearedCount: count });
//
//       res.json({
//         message: 'Event history cleared',
//         clearedCount: count
//       });
//     });
//   }
//
//   /**
//    * ç›‘æ§è·¯ç”±
//    */
//   private setupMonitorRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // å®æ—¶äº‹ä»¶æµ (æ¨¡æ‹ŸServer-Sent Events)
//     this.server.get('/api/events/stream', (req: HttpRequest, res: HttpResponse) => {
//       // åœ¨çœŸå®å®ç°ä¸­ï¼Œè¿™é‡Œä¼šå»ºç«‹SSEè¿æ¥
//       const recentEvents = this.eventHistory.slice(-10).reverse();
//
//       res.json({
//         message: 'Event stream endpoint',
//         note: 'In real implementation, this would be a Server-Sent Events stream',
//         recentEvents,
//         streamUrl: '/api/events/stream'
//       });
//     });
//
//     // äº‹ä»¶ç›‘æ§ä»ªè¡¨æ¿æ•°æ®
//     this.server.get('/api/monitor/dashboard', (req: HttpRequest, res: HttpResponse) => {
//       const now = new Date();
//       const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
//
//       const recentEvents = this.eventHistory.filter(event =>
//       event.timestamp >= oneHourAgo
//       );
//
//       const dashboard = {
//         server: {
//           status: this.isRunning ? 'running' : 'stopped',
//           // uptime: process.uptime(),
//           clientCount: this.server?.getClientCount() || 0
//         },
//         events: {
//           total: this.eventHistory.length,
//           lastHour: recentEvents.length,
//           errorCount: recentEvents.filter(e => e.level === 'error').length,
//           warningCount: recentEvents.filter(e => e.level === 'warn').length
//         },
//         activity: this.getActivityTimeline(recentEvents)
//       };
//
//       res.json(dashboard);
//     });
//   }
//
//   /**
//    * äº‹ä»¶è§¦å‘è·¯ç”±
//    */
//   private setupTriggerRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
//     this.server.post('/api/events/trigger', (req: HttpRequest, res: HttpResponse) => {
//       const { eventName, message, data, level = 'info' } = req.body as any;
//
//       if (!eventName) {
//         return res.status(400).json({ error: 'eventName is required' });
//       }
//
//       this.recordEvent({
//         type: 'custom',
//         eventName,
//         message: message || `Custom event: ${eventName}`,
//         data,
//         level: level as 'info' | 'warn' | 'error'
//       });
//
//       res.json({
//         message: 'Custom event triggered',
//         eventName,
//         triggeredAt: new Date().toISOString()
//       });
//     });
//
//     // æ¨¡æ‹Ÿé”™è¯¯äº‹ä»¶
//     this.server.post('/api/events/simulate-error', (req: HttpRequest, res: HttpResponse) => {
//       const { errorType = 'test_error', message = 'Simulated error for testing' } = req.body as any;
//
//       this.recordEvent({
//         type: 'error',
//         eventName: errorType,
//         message,
//         data: { simulated: true, triggeredBy: 'api' },
//         level: 'error'
//       });
//
//       res.json({
//         message: 'Error event simulated',
//         errorType,
//         simulatedAt: new Date().toISOString()
//       });
//     });
//
//     // æ‰¹é‡è§¦å‘äº‹ä»¶
//     this.server.post('/api/events/batch-trigger', (req: HttpRequest, res: HttpResponse) => {
//       const { events } = req.body as { events: any[] };
//
//       if (!Array.isArray(events)) {
//         return res.status(400).json({ error: 'events must be an array' });
//       }
//
//       const triggeredEvents = events.map(eventData => {
//         this.recordEvent({
//           type: 'custom',
//           eventName: eventData.eventName || 'batch_event',
//           message: eventData.message || 'Batch triggered event',
//           data: eventData.data,
//           level: eventData.level || 'info'
//         });
//
//         return {
//           eventName: eventData.eventName,
//           triggeredAt: new Date().toISOString()
//         };
//       });
//
//       res.json({
//         message: 'Batch events triggered',
//         count: triggeredEvents.length,
//         events: triggeredEvents
//       });
//     });
//   }
//
//   /**
//    * åˆ†æäº‹ä»¶ç»Ÿè®¡
//    */
//   // private analyzeEvents() {
//   //   // æŒ‰ç±»å‹ç»Ÿè®¡
//   //   const byType: Record<string, number> = {};
//   //   this.eventHistory.forEach(event => {
//   //     byType[event.type] = (byType[event.type] || 0) + 1;
//   //   });
//   //
//   //   // æŒ‰çº§åˆ«ç»Ÿè®¡
//   //   const byLevel: Record<string, number> = {};
//   //   this.eventHistory.forEach(event => {
//   //     byLevel[event.level] = (byLevel[event.level] || 0) + 1;
//   //   });
//   //
//   //   // æœ€è¿‘æ´»åŠ¨
//   //   const now = new Date();
//   //   const recentActivity = this.eventHistory.filter(event =>
//   //   now.getTime() - event.timestamp.getTime() < 10 * 60 * 1000 // æœ€è¿‘10åˆ†é’Ÿ
//   //   ).length;
//   //
//   //   // çƒ­é—¨äº‹ä»¶
//   //   const eventCounts: Record<string, number> = {};
//   //   this.eventHistory.forEach(event => {
//   //     eventCounts[event.eventName] = (eventCounts[event.eventName] || 0) + 1;
//   //   });
//   //
//   //   // const topEvents = Object.entries(eventCounts)
//   //   //   .sort(([, a], [, b]) => b - a)
//   //   //   .slice(0, 5)
//   //   //   .map(([eventName, count]) => ({ eventName, count } as ESObject));
//   //
//   //   return {
//   //     byType,
//   //     byLevel,
//   //     recentActivity,
//   //     // topEvents
//   //   } as ESObject;
//   // }
//
//   /**
//    * è·å–æ´»åŠ¨æ—¶é—´çº¿
//    */
//   private getActivityTimeline(events: EventRecord[]) {
//     const timeline: Record<string, number> = {};
//
//     events.forEach(event => {
//       const hour = event.timestamp.getHours();
//       const key = `${hour}:00`;
//       timeline[key] = (timeline[key] || 0) + 1;
//     });
//
//     return timeline;
//   }
//
//   /**
//    * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
//    */
//   private setupGlobalErrorHandler(): void {
//     if (!this.server) {
//       return;
//     }
//
//     const errorHandler: ErrorHandler = (error, req, res, next) => {
//       console.error(`ğŸš¨ [Event Error Handler] ${req.method} ${req.path}: ${error.message}`);
//
//       // è®°å½•é”™è¯¯å¤„ç†äº‹ä»¶
//       // this.recordEvent({
//       //   type: 'error',
//       //   eventName: 'global_error_handler',
//       //   message: `Global error: ${error.message}`,
//       //   data: {
//       //     path: req.path,
//       //     method: req.method,
//       //     error: error.message
//       //   },
//       //   level: 'error'
//       // });
//
//       if (res.isHeadersSent()) {
//         return next(error);
//       }
//
//       res.status(500).json({
//         error: 'Event Server Error',
//         message: error.message,
//         timestamp: new Date().toISOString()
//       });
//     };
//
//     this.server.use(errorHandler);
//   }
//
//   /**
//    * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
//    */
//   private printApiEndpoints(info: ServerInfo): void {
//     const baseUrl = `http://${info.address}:${info.port}`;
//
//     console.log('\nğŸ“¡ Event APIç«¯ç‚¹:');
//     console.log('='.repeat(50));
//
//     console.log('ğŸ“„ æ¼”ç¤ºé¡µé¢:');
//     console.log(`   GET  ${baseUrl}/event-demo.html         - Eventæ¼”ç¤ºé¡µé¢`);
//     console.log(`   GET  ${baseUrl}/event-monitor.html      - äº‹ä»¶ç›‘æ§é¡µé¢`);
//
//     console.log('\nğŸ“Š äº‹ä»¶æŸ¥è¯¢:');
//     console.log(`   GET    ${baseUrl}/api/events            - è·å–äº‹ä»¶å†å²`);
//     console.log(`   GET    ${baseUrl}/api/events/:id        - è·å–ç‰¹å®šäº‹ä»¶`);
//     console.log(`   GET    ${baseUrl}/api/events/stats      - è·å–äº‹ä»¶ç»Ÿè®¡`);
//     console.log(`   DELETE ${baseUrl}/api/events            - æ¸…é™¤äº‹ä»¶å†å²`);
//
//     console.log('\nğŸ“¡ äº‹ä»¶ç›‘æ§:');
//     console.log(`   GET    ${baseUrl}/api/events/stream     - å®æ—¶äº‹ä»¶æµ`);
//     console.log(`   GET    ${baseUrl}/api/monitor/dashboard - ç›‘æ§ä»ªè¡¨æ¿`);
//
//     console.log('\nğŸ¯ äº‹ä»¶è§¦å‘:');
//     console.log(`   POST   ${baseUrl}/api/events/trigger    - è§¦å‘è‡ªå®šä¹‰äº‹ä»¶`);
//     console.log(`   POST   ${baseUrl}/api/events/simulate-error - æ¨¡æ‹Ÿé”™è¯¯äº‹ä»¶`);
//     console.log(`   POST   ${baseUrl}/api/events/batch-trigger - æ‰¹é‡è§¦å‘äº‹ä»¶`);
//
//     console.log('='.repeat(50));
//   }
// }