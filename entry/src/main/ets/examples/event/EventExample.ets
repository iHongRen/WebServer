/**
 * @fileName : EventExample.ets
 * @author : @cxy
 * @date : 2025/10/29
 * @description : Eventç¤ºä¾‹ - å±•ç¤ºæœåŠ¡å™¨äº‹ä»¶ç³»ç»ŸåŠŸèƒ½
 */

import { common } from '@kit.AbilityKit';
import {
  HttpServer,
  ErrorHandler,
  ServerInfo,
  ServerEventType,
  ServerErrorType,
  HttpRequest,
  HttpResponse,
  ServerError,
  ServerEvent,
} from '@cxy/webserver';


/**
 * Eventç¤ºä¾‹ç±»
 * å±•ç¤ºæœåŠ¡å™¨äº‹ä»¶ç³»ç»Ÿçš„å„ç§åŠŸèƒ½
 */
export class EventExample {
  private server: HttpServer | null = null;

  /**
   * åˆå§‹åŒ–æœåŠ¡å™¨
   */
  public initializeServer(): void {
    this.server = new HttpServer();
    this.setupEventHandling();
    this.setupMiddleware();
    this.setupRoutes()
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  public async start(port: number): Promise<ServerInfo | null> {
    if (!this.server) {
      this.initializeServer();
    }

    const info = await this.server?.startServer(port);
    if (info) {
      console.log('âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
      console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
      this.printApiEndpoints(info);
      return info;
    } else {
      console.error('âŒ å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:');
      return null
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  public async stop(): Promise<void> {
    if (this.server) {
      await this.server.stopServer();
    }
  }

  /**
   * é…ç½®æµ‹è¯•è·¯ç”±
   */
  private setupRoutes(): void {
    const server = this.server
    if (!server) {
      return
    }

    // é¦–é¡µ
    server.get('/', (req: HttpRequest, res: HttpResponse) => {
      res.json({
        message: 'HTTPæœåŠ¡å™¨è¿è¡Œæ­£å¸¸',
        timestamp: new Date().toISOString(),
        clientCount: server.getClientCount(),
        serverRunning: server.isServerRunning()
      });
    });

    // æœåŠ¡å™¨çŠ¶æ€ç«¯ç‚¹
    server.get('/status', async (req: HttpRequest, res: HttpResponse) => {
      const clients = server.getClients().map(client => client.clientId);

      res.json({
        status: 'running',
        clientCount: server.getClientCount(),
        clients: clients,
        timestamp: new Date().toISOString()
      });
    });

    // æ¨¡æ‹Ÿé”™è¯¯çš„ç«¯ç‚¹
    server.get('/error', (req: HttpRequest, res: HttpResponse) => {
      // æ•…æ„æŠ›å‡ºé”™è¯¯æ¥æµ‹è¯•é”™è¯¯å¤„ç†
      throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯');
    });

    // æ–­å¼€æŒ‡å®šå®¢æˆ·ç«¯è¿æ¥
    server.post('/disconnect/:clientId', async (req: HttpRequest, res: HttpResponse) => {
      const clientId = Number(req.params['clientId']);
      const success = await server.disconnectClient(clientId);

      res.json({
        success,
        message: success ? `å®¢æˆ·ç«¯ ${clientId} å·²æ–­å¼€è¿æ¥` : `å®¢æˆ·ç«¯ ${clientId} ä¸å­˜åœ¨æˆ–æ–­å¼€å¤±è´¥`
      });
    });
  }

  /**
   * è®¾ç½®äº‹ä»¶å¤„ç†
   */
  private setupEventHandling(): void {
    if (!this.server) {
      return;
    }

    // ç›‘å¬æœåŠ¡å™¨é”™è¯¯äº‹ä»¶
    this.server.onError((error) => {
      console.error(`æœåŠ¡å™¨é”™è¯¯ [${error.type}]:`, JSON.stringify(error.error));

      // æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
      switch (error.type) {
        case ServerErrorType.STARTUP_FAILED:
          console.error('æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨');
          // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•é€»è¾‘æˆ–é€šçŸ¥ç®¡ç†å‘˜
          break;

        case ServerErrorType.LISTEN_ERROR:
          console.error('ç«¯å£ç›‘å¬å¤±è´¥ï¼Œå¯èƒ½ç«¯å£å·²è¢«å ç”¨');
          // å¯ä»¥å°è¯•å…¶ä»–ç«¯å£
          break;

        case ServerErrorType.CONNECTION_ERROR:
          console.error('è¿æ¥é”™è¯¯ï¼Œå®¢æˆ·ç«¯è¿æ¥å¼‚å¸¸');
          break;

        case ServerErrorType.CLIENT_ERROR:
          console.error('å®¢æˆ·ç«¯é”™è¯¯');
          break;

        case ServerErrorType.SOCKET_ERROR:
          console.error('Socketé”™è¯¯');
          break;

        default:
          console.error('æœªçŸ¥é”™è¯¯ç±»å‹');
      }
    });

    // ç›‘å¬æœåŠ¡å™¨äº‹ä»¶
    Object.values(ServerEventType).forEach(eventType => {
      this.server!.on(eventType, (event) => {
        console.log(`ğŸ“¡ æœåŠ¡å™¨äº‹ä»¶ [${eventType}]: ${JSON.stringify(event.data)}`);
      });
    });

  }

  /**
   * é…ç½®ä¸­é—´ä»¶
   */
  private setupMiddleware(): void {
    if (!this.server) {
      return;
    }

    this.server.logger();
    this.server.cors();
    this.server.auto();
  }

  /**
   * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
   */
  private printApiEndpoints(info: ServerInfo): void {
    const baseUrl = `http://${info.address}:${info.port}`;

    console.log('\nğŸ“¡ Event APIç«¯ç‚¹:');
    console.log('='.repeat(50));
    console.log(`   GET ${baseUrl}/        (è¿”å›æœåŠ¡å™¨çŠ¶æ€å’Œå®¢æˆ·ç«¯æ•°é‡)`);
    console.log(`   GET ${baseUrl}/status  (è¿”å›æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€å’Œå®¢æˆ·ç«¯ä¿¡æ¯)`);
    console.log(`   GET ${baseUrl}/error   (æ•…æ„è§¦å‘é”™è¯¯ä»¥æµ‹è¯•é”™è¯¯å¤„ç†)`);
    console.log(`   POST ${baseUrl}/disconnect/:clientId (æ–­å¼€æŒ‡å®šå®¢æˆ·ç«¯è¿æ¥)`);
    console.log('='.repeat(50));
  }
}