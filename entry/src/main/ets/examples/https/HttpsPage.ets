/**
 * @fileName : HttpsPage.ets
 * @author : @cxy
 * @date : 2025/10/29
 * @description : HTTPSæœåŠ¡å™¨ç¤ºä¾‹é¡µé¢
 */

import { common } from '@kit.AbilityKit';
import { HttpsExample } from './HttpsExample';
import { socket } from '@kit.NetworkKit';

@Builder
function httpsBuilder() {
  HttpsPage()
}

@Component
struct HttpsPage {
  @State title: string = 'HTTPSæœåŠ¡å™¨ç¤ºä¾‹'
  @State httpsExample: HttpsExample = new HttpsExample();
  @State serverInfo: socket.NetAddress | null = null;
  @State port: number = 8443;
  @State errorMessage: string = '';
  @State successMessage: string = '';

  aboutToAppear() {
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    this.httpsExample.init(context);
    this.startServer();
  }

  aboutToDisappear() {
    this.stopServer();
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  async startServer() {
    this.errorMessage = '';
    this.successMessage = '';

    const info = await this.httpsExample.start(this.port);
    if (info) {
      this.serverInfo = info;
      this.successMessage = `ðŸŸ¢æœåŠ¡å™¨è¿è¡Œä¸­`;
    } else {
      this.errorMessage = 'ðŸ›‘ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥';
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  async stopServer() {
    this.errorMessage = '';
    this.successMessage = '';
    await this.httpsExample.stop();
    this.serverInfo = null;
    this.successMessage = 'HTTPSæœåŠ¡å™¨å·²åœæ­¢';
  }

  build() {
    NavDestination() {
      Column({ space: 20 }) {
        // æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
        if (this.errorMessage) {
          Text(this.errorMessage)
            .fontColor(Color.Red)
            .fontSize(14)
            .padding(10)
            .backgroundColor('#ffebee')
            .borderRadius(8)
            .width('90%')
            .textAlign(TextAlign.Center)
        } else if (this.successMessage) {
          Text(this.successMessage)
            .fontColor(Color.Green)
            .fontSize(14)
            .padding(10)
            .backgroundColor('#e8f5e8')
            .borderRadius(8)
            .width('90%')
            .textAlign(TextAlign.Center)
        }

        // æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€
        if (this.serverInfo) {
          Column({ space: 15 }) {
            // æœåŠ¡å™¨ä¿¡æ¯å¡ç‰‡
            Column({ space: 10 }) {
              Row() {
                Text('HTTPSåœ°å€:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                  .fontSize(14)

                Text(`https://${this.serverInfo.address}:${this.serverInfo.port}`)
                  .fontColor(Color.Blue)
                  .fontSize(16)
                  .layoutWeight(1)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
            }
            .padding(15)
            .backgroundColor('#f0f8ff')
            .borderRadius(10)
            .width('90%')

            // APIç«¯ç‚¹ä¿¡æ¯
            Column({ space: 8 }) {
              Text('ä¸»è¦APIç«¯ç‚¹:')
                .fontWeight(FontWeight.Medium)
                .fontSize(14)

              Column({ space: 4 }) {
                Text('â€¢ GET /api/secure/users - å®‰å…¨ç”¨æˆ·åˆ—è¡¨')
                  .fontSize(12)
                  .fontColor(Color.Gray)
                Text('â€¢ POST /api/secure/login - å®‰å…¨ç™»å½•')
                  .fontSize(12)
                  .fontColor(Color.Gray)
                Text('â€¢ GET /api/ssl/info - SSLè¯ä¹¦ä¿¡æ¯')
                  .fontSize(12)
                  .fontColor(Color.Gray)
                Text('â€¢ POST /api/secure/upload - å®‰å…¨æ–‡ä»¶ä¸Šä¼ ')
                  .fontSize(12)
                  .fontColor(Color.Gray)
              }
              .alignItems(HorizontalAlign.Start)
            }
            .padding(15)
            .backgroundColor('#f5f5f5')
            .borderRadius(10)
            .width('90%')
            .alignItems(HorizontalAlign.Start)

            // åœæ­¢æŒ‰é’®
            Button('åœæ­¢HTTPSæœåŠ¡å™¨')
              .width('80%')
              .height(50)
              .backgroundColor(Color.Red)
              .onClick(() => {
                this.stopServer();
              })
          }
          .width('100%')
        }

        // æœåŠ¡å™¨æœªè¿è¡ŒçŠ¶æ€
        else {
          Column({ space: 20 }) {
            // é…ç½®åŒºåŸŸ
            Column({ space: 15 }) {
              Text('HTTPSæœåŠ¡å™¨é…ç½®')
                .fontWeight(FontWeight.Medium)
                .fontSize(16)

              // ç«¯å£é…ç½®
              Row() {
                Text('ç«¯å£å·:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                TextInput({
                  text: this.port.toString(),
                  placeholder: 'è¯·è¾“å…¥ç«¯å£å· (1-65535)'
                })
                  .type(InputType.Number)
                  .layoutWeight(1)
                  .height(40)
                  .onChange((value) => {
                    this.port = parseInt(value) || 8443;
                  })
              }
              .width('100%')

            }
            .padding(15)
            .backgroundColor('#f5f5f5')
            .borderRadius(10)
            .width('90%')
            .alignItems(HorizontalAlign.Start)

            // å¯åŠ¨æŒ‰é’®
            Button('å¯åŠ¨HTTPSæœåŠ¡å™¨')
              .enabled(this.port > 0)
              .width('80%')
              .height(50)
              .backgroundColor(Color.Blue)
              .onClick(() => {
                this.startServer();
              })
          }
          .width('100%')
        }
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .justifyContent(FlexAlign.Start)
    }
    .title(this.title)
    .onReady((ctx) => {
      if (ctx.pathInfo.param) {
        this.title = ctx.pathInfo.param as string;
      }
    })
  }
}

