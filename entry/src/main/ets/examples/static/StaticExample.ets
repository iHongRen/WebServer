/**
 * @fileName : StaticExample.ets
 * @author : @cxy
 * @date : 2025/10/29
 * @description : Staticç¤ºä¾‹ - å±•ç¤ºé™æ€æ–‡ä»¶æœåŠ¡åŠŸèƒ½
 */

import { fileIo } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import {
  HttpServer, HttpRequest, HttpResponse,
} from '@cxy/webserver';
import { util } from '@kit.ArkTS';
import { socket } from '@kit.NetworkKit';

/**
 * é™æ€æ–‡ä»¶
 */
interface FileItem {
  name: string,
  path: string,
  isDirectory: boolean,
  size: number,
  mtime: string
}

/**
 * æ–‡ä»¶è®¿é—®è®°å½•æ¥å£
 */
interface FileAccessRecord {
  id: number;
  filePath: string;
  fileSize: number;
  mimeType: string;
  clientIP: string;
  userAgent: string;
  timestamp: Date;
  responseTime: number;
  statusCode: number;
}

/**
 * Staticç¤ºä¾‹ç±»
 * å±•ç¤ºé™æ€æ–‡ä»¶æœåŠ¡çš„å„ç§åŠŸèƒ½
 */
export class StaticExample {
  public staticRoot: string = ''
  private server: HttpServer | null = null;
  private context?: common.UIAbilityContext;

  init(context: common.UIAbilityContext) {
    this.context = context;
    this.staticRoot = context.filesDir + '/staticExample'
    this.setupStaticFiles()
  }

  /**
   * è®¾ç½®é™æ€æ–‡ä»¶
   */
  public async setupStaticFiles(): Promise<void> {
    const access = await fileIo.access(this.staticRoot);
    if (!access) {
      await fileIo.mkdir(this.staticRoot);
    }

    // åˆ›å»ºç¤ºä¾‹æ–‡ä»¶ç»“æ„
    await this.createExampleFiles();
  }

  /**
   * åˆå§‹åŒ–æœåŠ¡å™¨
   */
  public initializeServer(): void {
    this.server = new HttpServer();
    this.setupMiddleware();
    this.setupRoutes();
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  public async start(port: number): Promise<socket.NetAddress | null> {
    if (!this.server) {
      this.initializeServer();
    }

    const info = await this.server?.startServer(port);
    if (info) {
      console.log('âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
      console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
      this.printApiEndpoints(info);
      return info;
    } else {
      console.error('âŒ å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:');
      return null;
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  public async stop(): Promise<void> {
    if (this.server) {
      await this.server.stopServer();
    }
  }


  /**
   * åˆ›å»ºç¤ºä¾‹æ–‡ä»¶
   */
  private async createExampleFiles(): Promise<void> {
    // åˆ›å»ºå­ç›®å½•
    const dirs = ['css', 'js', 'images', 'docs'];
    for (const dir of dirs) {
      const dirPath = `${this.staticRoot}/${dir}`;
      const exists = await fileIo.access(dirPath);
      if (!exists) {
        await fileIo.mkdir(dirPath);
      }
    }

    // åˆ›å»ºç¤ºä¾‹HTMLæ–‡ä»¶
    await this.createFile('index.html', `<!DOCTYPE html>
<html>
<head>
    <title>Static File Server Demo</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <h1>é™æ€æ–‡ä»¶æœåŠ¡å™¨æ¼”ç¤º</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªé™æ€HTMLæ–‡ä»¶ç¤ºä¾‹</p>
    <img src="/images/logo.png" alt="Logo" style="max-width: 200px;">
    <script src="/js/app.js"></script>
</body>
</html>`);

    // åˆ›å»ºCSSæ–‡ä»¶
    await this.createFile('css/style.css', `body {
    font-family: Arial, sans-serif;
    margin: 40px;
    background-color: #f5f5f5;
}

h1 {
    color: #333;
    text-align: center;
}

p {
    color: #666;
    line-height: 1.6;
}`);

    // åˆ›å»ºJavaScriptæ–‡ä»¶
    await this.createFile('js/app.js', `console.log('Static file server is working!');

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded successfully');

    // æ·»åŠ ä¸€äº›äº¤äº’
    const h1 = document.querySelector('h1');
    if (h1) {
        h1.addEventListener('click', function() {
            alert('Hello from static JavaScript!');
        });
    }
});`);

    // åˆ›å»ºæ–‡æ¡£æ–‡ä»¶
    await this.createFile('docs/readme.txt', `Static File Server Documentation

This is a demonstration of static file serving capabilities.

Features:
- File serving with proper MIME types
- Caching support
- Access logging
- File browser
- Upload functionality

Created: ${new Date().toISOString()}`);

    // åˆ›å»ºJSONæ•°æ®æ–‡ä»¶
    await this.createFile('data.json', JSON.stringify({
      name: 'Static File Server',
      version: '1.0.0',
      features: ['file serving', 'caching', 'logging'],
      created: new Date().toISOString()
    }, null, 2));
  }

  /**
   * åˆ›å»ºæ–‡ä»¶
   */
  private async createFile(relativePath: string, content: string): Promise<void> {
    try {
      const filePath = `${this.staticRoot}/${relativePath}`;
      const file = await fileIo.open(filePath,
        fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
      await fileIo.write(file.fd, util.TextEncoder.create().encodeInto(content).buffer);
      await fileIo.close(file.fd);
    } catch (error) {
      console.warn(`åˆ›å»ºæ–‡ä»¶å¤±è´¥ ${relativePath}:`, error);
    }
  }


  /**
   * é…ç½®ä¸­é—´ä»¶
   */
  private setupMiddleware(): void {
    if (!this.server) {
      return;
    }

    this.server.logger()
    this.server.cors();
    this.server.auto();

    // é…ç½®é™æ€æ–‡ä»¶æœåŠ¡
    this.server.serveStatic(this.staticRoot, {
      maxAge: 0, //ä¸ç¼“å­˜
    });
  }


  /**
   * æ–‡ä»¶ç®¡ç†è·¯ç”±
   */
  private setupRoutes(): void {
    if (!this.server) {
      return;
    }

    // æ–‡ä»¶æµè§ˆå™¨API
    this.server.get('/api/files', async (req: HttpRequest, res: HttpResponse) => {
      try {
        const path = req.query.get('path') || '';
        const fullPath = `${this.staticRoot}/${path}`.replace(/\/+/g, '/');

        const files = await fileIo.listFile(fullPath);
        const fileList: FileItem[] = [];

        for (const fileName of files) {
          const filePath = `${fullPath}/${fileName}`;
          try {
            const stat = await fileIo.stat(filePath);
            fileList.push({
              name: fileName,
              path: `${path}/${fileName}`.replace(/^\//, ''),
              isDirectory: stat.isDirectory(),
              size: stat.size,
              mtime: new Date(stat.mtime).toISOString()
            });
          } catch (e) {
            // å¿½ç•¥æ— æ³•è®¿é—®çš„æ–‡ä»¶
          }
        }

        res.json({
          currentPath: path,
          files: fileList.sort((a, b) => {
            if (a.isDirectory && !b.isDirectory) {
              return -1;
            }
            if (!a.isDirectory && b.isDirectory) {
              return 1;
            }
            return a.name.localeCompare(b.name);
          })
        });
      } catch (error) {
        res.status(500).json({ error: 'Failed to list files' });
      }
    });

    // æ–‡ä»¶ä¸Šä¼ API
    this.server.post('/api/upload', async (req: HttpRequest, res: HttpResponse) => {
      try {
        const uploadedFile = req.files?.['file'];

        if (!uploadedFile) {
          return res.status(400).json({ error: 'No file uploaded' });
        }

        const fileName = uploadedFile.fileName;
        const filePath = `${this.staticRoot}/${fileName}`;

        const file = await fileIo.open(filePath,
          fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
        await fileIo.write(file.fd, uploadedFile.data);
        await fileIo.close(file.fd);

        res.json({
          message: 'File uploaded successfully',
          fileName,
          size: uploadedFile.data.byteLength,
          url: `/${fileName}`
        });
      } catch (error) {
        res.status(500).json({ error: 'Upload failed' });
      }
    });

    // æ–‡ä»¶åˆ é™¤API
    this.server.delete('/api/files/*', async (req: HttpRequest, res: HttpResponse) => {
      try {
        const filePath = req.path.replace('/api/files/', '');
        const fullPath = `${this.staticRoot}/${filePath}`;

        await fileIo.unlink(fullPath);

        res.json({
          message: 'File deleted successfully',
          filePath
        });
      } catch (error) {
        res.status(500).json({ error: 'Delete failed' });
      }
    });
  }


  /**
   * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
   */
  private printApiEndpoints(info: socket.NetAddress): void {
    const baseUrl = `http://${info.address}:${info.port}`;

    console.log('\n Static File Server APIç«¯ç‚¹:');
    console.log('='.repeat(50));

    console.log(' é™æ€æ–‡ä»¶:');
    console.log(`   GET  ${baseUrl}/                      - é¦–é¡µ`);
    console.log(`   GET  ${baseUrl}/css/style.css         - CSSæ–‡ä»¶`);
    console.log(`   GET  ${baseUrl}/js/app.js             - JavaScriptæ–‡ä»¶`);
    console.log(`   GET  ${baseUrl}/data.json             - JSONæ•°æ®`);

    console.log('\n æ–‡ä»¶ç®¡ç†:');
    console.log(`   GET    ${baseUrl}/api/files           - æ–‡ä»¶æµè§ˆå™¨`);
    console.log(`   POST   ${baseUrl}/api/upload          - æ–‡ä»¶ä¸Šä¼ `);
    console.log(`   DELETE ${baseUrl}/api/files/*         - æ–‡ä»¶åˆ é™¤`);

    console.log('='.repeat(50));
  }
}
