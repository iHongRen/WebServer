// /**
//  * @fileName : StaticExample.ets
//  * @author : @cxy
//  * @date : 2025/10/29
//  * @description : Staticç¤ºä¾‹ - å±•ç¤ºé™æ€æ–‡ä»¶æœåŠ¡åŠŸèƒ½
//  */
//
// import { fileIo } from '@kit.CoreFileKit';
// import { common } from '@kit.AbilityKit';
// import {
//   HttpServer,
//   ErrorHandler,
//   ServerInfo,
//   ServerEventType,
//   HttpRequest,
//   HttpResponse,
// } from '@cxy/webserver';
// import { util } from '@kit.ArkTS';
//
// /**
//  * é™æ€æ–‡ä»¶é…ç½®æ¥å£
//  */
// interface StaticConfig {
//   port: number;
//   staticRoot: string;
//   enableLogging: boolean;
//   enableCors: boolean;
//   enableCache: boolean;
//   maxAge: number;
// }
//
// /**
//  * æ–‡ä»¶è®¿é—®è®°å½•æ¥å£
//  */
// interface FileAccessRecord {
//   id: number;
//   filePath: string;
//   fileSize: number;
//   mimeType: string;
//   clientIP: string;
//   userAgent: string;
//   timestamp: Date;
//   responseTime: number;
//   statusCode: number;
// }
//
// /**
//  * Staticç¤ºä¾‹ç±»
//  * å±•ç¤ºé™æ€æ–‡ä»¶æœåŠ¡çš„å„ç§åŠŸèƒ½
//  */
// export class StaticExample {
//   private server: HttpServer | null = null;
//   private serverInfo: ServerInfo | null = null;
//   private isRunning: boolean = false;
//   private config: StaticConfig;
//   private context: common.UIAbilityContext;
//   // æ–‡ä»¶è®¿é—®è®°å½•
//   private accessRecords: FileAccessRecord[] = [];
//   private nextRecordId: number = 1;
//   // æ–‡ä»¶ç¼“å­˜ç»Ÿè®¡
//   private cacheStats = {
//     hits: 0,
//     misses: 0,
//     totalSize: 0
//   };
//
//   constructor(context: common.UIAbilityContext, config?: Partial<StaticConfig>) {
//     this.context = context;
//     this.config = {
//       port: config?.port || 8087,
//       staticRoot: config?.staticRoot || context.filesDir + '/static',
//       enableLogging: config?.enableLogging || true,
//       enableCors: config?.enableCors || true,
//       enableCache: config?.enableCache || true,
//       maxAge: config?.maxAge || 3600, // 1å°æ—¶ç¼“å­˜
//     };
//   }
//
//   /**
//    * è®¾ç½®é™æ€æ–‡ä»¶
//    */
//   public async setupStaticFiles(): Promise<void> {
//     const access = await fileIo.access(this.config.staticRoot);
//     if (!access) {
//       await fileIo.mkdir(this.config.staticRoot);
//     }
//
//     // åˆ›å»ºç¤ºä¾‹æ–‡ä»¶ç»“æ„
//     await this.createExampleFiles();
//   }
//
//   /**
//    * åˆå§‹åŒ–æœåŠ¡å™¨
//    */
//   public initializeServer(): void {
//     this.server = new HttpServer();
//
//     this.setupEventHandling();
//     this.setupMiddleware();
//     this.setupRoutes();
//     this.setupGlobalErrorHandler();
//   }
//
//   /**
//    * å¯åŠ¨æœåŠ¡å™¨
//    */
//   public async start(): Promise<ServerInfo | null> {
//     try {
//       if (!this.server) {
//         this.initializeServer();
//       }
//
//       if (!this.server) {
//         throw new Error('StaticæœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥');
//       }
//
//       const info = await this.server.startServer(this.config.port);
//
//       if (info.address) {
//         this.serverInfo = info;
//         this.isRunning = true;
//
//         console.log('âœ… StaticæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
//         console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
//         this.printApiEndpoints(info);
//
//         return info;
//       } else {
//         throw new Error('æœªèƒ½è·å–æœåŠ¡å™¨åœ°å€');
//       }
//     } catch (error) {
//       console.error('âŒ å¯åŠ¨StaticæœåŠ¡å™¨å¤±è´¥:', error);
//       this.isRunning = false;
//       return null;
//     }
//   }
//
//   /**
//    * åœæ­¢æœåŠ¡å™¨
//    */
//   public async stop(): Promise<void> {
//     if (this.server && this.isRunning) {
//       await this.server.stopServer();
//       this.isRunning = false;
//       this.serverInfo = null;
//       console.log('ğŸ›‘ StaticæœåŠ¡å™¨å·²åœæ­¢');
//     }
//   }
//
//   // Getteræ–¹æ³•
//   public getServerInfo(): ServerInfo | null {
//     return this.serverInfo;
//   }
//
//   public getIsRunning(): boolean {
//     return this.isRunning;
//   }
//
//   public getConfig(): StaticConfig {
//     return this.config;
//   }
//
//   public getAccessCount(): number {
//     return this.accessRecords.length;
//   }
//
//   /**
//    * åˆ›å»ºç¤ºä¾‹æ–‡ä»¶
//    */
//   private async createExampleFiles(): Promise<void> {
//     // åˆ›å»ºå­ç›®å½•
//     const dirs = ['css', 'js', 'images', 'docs'];
//     for (const dir of dirs) {
//       const dirPath = `${this.config.staticRoot}/${dir}`;
//       const exists = await fileIo.access(dirPath);
//       if (!exists) {
//         await fileIo.mkdir(dirPath);
//       }
//     }
//
//     // åˆ›å»ºç¤ºä¾‹HTMLæ–‡ä»¶
//     await this.createFile('index.html', `<!DOCTYPE html>
// <html>
// <head>
//     <title>Static File Server Demo</title>
//     <link rel="stylesheet" href="/css/style.css">
// </head>
// <body>
//     <h1>é™æ€æ–‡ä»¶æœåŠ¡å™¨æ¼”ç¤º</h1>
//     <p>è¿™æ˜¯ä¸€ä¸ªé™æ€HTMLæ–‡ä»¶ç¤ºä¾‹</p>
//     <img src="/images/logo.png" alt="Logo" style="max-width: 200px;">
//     <script src="/js/app.js"></script>
// </body>
// </html>`);
//
//     // åˆ›å»ºCSSæ–‡ä»¶
//     await this.createFile('css/style.css', `body {
//     font-family: Arial, sans-serif;
//     margin: 40px;
//     background-color: #f5f5f5;
// }
//
// h1 {
//     color: #333;
//     text-align: center;
// }
//
// p {
//     color: #666;
//     line-height: 1.6;
// }`);
//
//     // åˆ›å»ºJavaScriptæ–‡ä»¶
//     await this.createFile('js/app.js', `console.log('Static file server is working!');
//
// document.addEventListener('DOMContentLoaded', function() {
//     console.log('Page loaded successfully');
//
//     // æ·»åŠ ä¸€äº›äº¤äº’
//     const h1 = document.querySelector('h1');
//     if (h1) {
//         h1.addEventListener('click', function() {
//             alert('Hello from static JavaScript!');
//         });
//     }
// });`);
//
//     // åˆ›å»ºæ–‡æ¡£æ–‡ä»¶
//     await this.createFile('docs/readme.txt', `Static File Server Documentation
//
// This is a demonstration of static file serving capabilities.
//
// Features:
// - File serving with proper MIME types
// - Caching support
// - Access logging
// - File browser
// - Upload functionality
//
// Created: ${new Date().toISOString()}`);
//
//     // åˆ›å»ºJSONæ•°æ®æ–‡ä»¶
//     await this.createFile('data.json', JSON.stringify({
//       name: 'Static File Server',
//       version: '1.0.0',
//       features: ['file serving', 'caching', 'logging'],
//       created: new Date().toISOString()
//     }, null, 2));
//   }
//
//   /**
//    * åˆ›å»ºæ–‡ä»¶
//    */
//   private async createFile(relativePath: string, content: string): Promise<void> {
//     try {
//       const filePath = `${this.config.staticRoot}/${relativePath}`;
//       const file = await fileIo.open(filePath,
//         fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
//       await fileIo.write(file.fd, new util.TextEncoder().encode(content).buffer);
//       await fileIo.close(file.fd);
//     } catch (error) {
//       console.warn(`åˆ›å»ºæ–‡ä»¶å¤±è´¥ ${relativePath}:`, error);
//     }
//   }
//
//   /**
//    * è®¾ç½®äº‹ä»¶å¤„ç†
//    */
//   private setupEventHandling(): void {
//     if (!this.server) {
//       return;
//     }
//
//     this.server.onError((error) => {
//       console.error(`ğŸš¨ StaticæœåŠ¡å™¨é”™è¯¯ [${error.type}]: ${JSON.stringify(error)}`);
//     });
//
//     this.server.on(ServerEventType.SERVER_STARTED, (event) => {
//       console.log('âœ… StaticæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ:', event.data);
//     });
//   }
//
//   /**
//    * é…ç½®ä¸­é—´ä»¶
//    */
//   private setupMiddleware(): void {
//     if (!this.server) {
//       return;
//     }
//
//     if (this.config.enableLogging) {
//       this.server.logger({
//         format: 'dev',
//         stream: (log: string) => console.log(`ğŸ“ ${log}`)
//       });
//     }
//
//     if (this.config.enableCors) {
//       this.server.cors({ origin: '*' });
//     }
//
//     // æ–‡ä»¶è®¿é—®è®°å½•ä¸­é—´ä»¶
//     this.server.use((req, res, next) => {
//       const startTime = Date.now();
//
//       res.onFinish((statusCode) => {
//         // åªè®°å½•é™æ€æ–‡ä»¶è®¿é—®
//         if (req.path.startsWith('/api/') || req.path === '/') {
//           return;
//         }
//
//         const responseTime = Date.now() - startTime;
//
//         const record: FileAccessRecord = {
//           id: this.nextRecordId++,
//           filePath: req.path,
//           fileSize: 0, // å®é™…å®ç°ä¸­å¯ä»¥è·å–æ–‡ä»¶å¤§å°
//           mimeType: res.get('content-type') || 'unknown',
//           clientIP: req.ip,
//           userAgent: req.userAgent,
//           timestamp: new Date(),
//           responseTime,
//           statusCode
//         };
//
//         this.accessRecords.push(record);
//
//         // é™åˆ¶è®°å½•æ•°é‡
//         if (this.accessRecords.length > 1000) {
//           this.accessRecords = this.accessRecords.slice(-1000);
//         }
//
//         // æ›´æ–°ç¼“å­˜ç»Ÿè®¡
//         if (statusCode === 304) {
//           this.cacheStats.hits++;
//         } else if (statusCode === 200) {
//           this.cacheStats.misses++;
//         }
//       });
//
//       next();
//     });
//
//     this.server.auto();
//
//     // é…ç½®é™æ€æ–‡ä»¶æœåŠ¡
//     this.server.serveStatic(this.config.staticRoot, {
//       maxAge: this.config.enableCache ? this.config.maxAge : 0,
//     });
//   }
//
//   /**
//    * é…ç½®è·¯ç”±
//    */
//   private setupRoutes(): void {
//     this.setupFileManagementRoutes();
//     this.setupStatisticsRoutes();
//     this.setupUtilityRoutes();
//   }
//
//   /**
//    * æ–‡ä»¶ç®¡ç†è·¯ç”±
//    */
//   private setupFileManagementRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // æ–‡ä»¶æµè§ˆå™¨API
//     this.server.get('/api/files', async (req: HttpRequest, res: HttpResponse) => {
//       try {
//         const path = req.query.get('path') || '';
//         const fullPath = `${this.config.staticRoot}/${path}`.replace(/\/+/g, '/');
//
//         const files = await fileIo.listFile(fullPath);
//         const fileList = [];
//
//         for (const fileName of files) {
//           const filePath = `${fullPath}/${fileName}`;
//           try {
//             const stat = await fileIo.stat(filePath);
//             fileList.push({
//               name: fileName,
//               path: `${path}/${fileName}`.replace(/^\//, ''),
//               isDirectory: stat.isDirectory(),
//               size: stat.size,
//               mtime: new Date(stat.mtime).toISOString()
//             });
//           } catch (e) {
//             // å¿½ç•¥æ— æ³•è®¿é—®çš„æ–‡ä»¶
//           }
//         }
//
//         res.json({
//           currentPath: path,
//           files: fileList.sort((a, b) => {
//             if (a.isDirectory && !b.isDirectory) {
//               return -1;
//             }
//             if (!a.isDirectory && b.isDirectory) {
//               return 1;
//             }
//             return a.name.localeCompare(b.name);
//           })
//         });
//       } catch (error) {
//         res.status(500).json({ error: 'Failed to list files' });
//       }
//     });
//
//     // æ–‡ä»¶ä¸Šä¼ API
//     this.server.post('/api/upload', async (req: HttpRequest, res: HttpResponse) => {
//       try {
//         const uploadedFile = req.files?.['file'];
//
//         if (!uploadedFile) {
//           return res.status(400).json({ error: 'No file uploaded' });
//         }
//
//         const fileName = uploadedFile.fileName;
//         const filePath = `${this.config.staticRoot}/${fileName}`;
//
//         const file = await fileIo.open(filePath,
//           fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
//         await fileIo.write(file.fd, uploadedFile.data);
//         await fileIo.close(file.fd);
//
//         res.json({
//           message: 'File uploaded successfully',
//           fileName,
//           size: uploadedFile.data.byteLength,
//           url: `/${fileName}`
//         });
//       } catch (error) {
//         res.status(500).json({ error: 'Upload failed' });
//       }
//     });
//
//     // æ–‡ä»¶åˆ é™¤API
//     this.server.delete('/api/files/*', async (req: HttpRequest, res: HttpResponse) => {
//       try {
//         const filePath = req.path.replace('/api/files/', '');
//         const fullPath = `${this.config.staticRoot}/${filePath}`;
//
//         await fileIo.unlink(fullPath);
//
//         res.json({
//           message: 'File deleted successfully',
//           filePath
//         });
//       } catch (error) {
//         res.status(500).json({ error: 'Delete failed' });
//       }
//     });
//   }
//
//   /**
//    * ç»Ÿè®¡è·¯ç”±
//    */
//   private setupStatisticsRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // è®¿é—®ç»Ÿè®¡
//     this.server.get('/api/stats', (req: HttpRequest, res: HttpResponse) => {
//       const stats = this.analyzeAccessStats();
//
//       res.json({
//         totalAccess: this.accessRecords.length,
//         cacheStats: this.cacheStats,
//         popularFiles: stats.popularFiles,
//         fileTypes: stats.fileTypes,
//         hourlyAccess: stats.hourlyAccess,
//         recentAccess: this.accessRecords.slice(-10).reverse()
//       });
//     });
//
//     // è®¿é—®è®°å½•
//     this.server.get('/api/access-log', (req: HttpRequest, res: HttpResponse) => {
//       const limit = parseInt(req.query.get('limit') || '50');
//       const offset = parseInt(req.query.get('offset') || '0');
//
//       const records = this.accessRecords
//         .slice(offset, offset + limit)
//         .reverse();
//
//       res.json({
//         records,
//         total: this.accessRecords.length,
//         limit,
//         offset
//       });
//     });
//
//     // æ¸…é™¤è®¿é—®è®°å½•
//     this.server.delete('/api/access-log', (req: HttpRequest, res: HttpResponse) => {
//       const count = this.accessRecords.length;
//       this.accessRecords = [];
//       this.nextRecordId = 1;
//       this.cacheStats = { hits: 0, misses: 0, totalSize: 0 };
//
//       res.json({
//         message: 'Access log cleared',
//         clearedCount: count
//       });
//     });
//   }
//
//   /**
//    * å·¥å…·è·¯ç”±
//    */
//   private setupUtilityRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // æœåŠ¡å™¨é…ç½®
//     this.server.get('/api/config', (req: HttpRequest, res: HttpResponse) => {
//       res.json({
//         config: this.config,
//         cacheEnabled: this.config.enableCache,
//         staticRoot: this.config.staticRoot
//       });
//     });
//
//     // æ›´æ–°ç¼“å­˜é…ç½®
//     this.server.post('/api/config/cache', (req: HttpRequest, res: HttpResponse) => {
//       const { enableCache, maxAge } = req.body as any;
//
//       if (enableCache !== undefined) {
//         this.config.enableCache = enableCache;
//       }
//
//       if (maxAge !== undefined) {
//         this.config.maxAge = maxAge;
//       }
//
//       res.json({
//         message: 'Cache configuration updated',
//         config: {
//           enableCache: this.config.enableCache,
//           maxAge: this.config.maxAge
//         }
//       });
//     });
//
//     // æ–‡ä»¶ä¿¡æ¯
//     this.server.get('/api/file-info/*', async (req: HttpRequest, res: HttpResponse) => {
//       try {
//         const filePath = req.path.replace('/api/file-info/', '');
//         const fullPath = `${this.config.staticRoot}/${filePath}`;
//
//         const stat = await fileIo.stat(fullPath);
//
//         res.json({
//           name: filePath.split('/').pop(),
//           path: filePath,
//           size: stat.size,
//           isDirectory: stat.isDirectory(),
//           mtime: new Date(stat.mtime).toISOString(),
//           atime: new Date(stat.atime).toISOString(),
//           ctime: new Date(stat.ctime).toISOString()
//         });
//       } catch (error) {
//         res.status(404).json({ error: 'File not found' });
//       }
//     });
//   }
//
//   /**
//    * åˆ†æè®¿é—®ç»Ÿè®¡
//    */
//   private analyzeAccessStats() {
//     const fileAccess: Record<string, number> = {};
//     const fileTypes: Record<string, number> = {};
//     const hourlyAccess: Record<string, number> = {};
//
//     this.accessRecords.forEach(record => {
//       // æ–‡ä»¶è®¿é—®ç»Ÿè®¡
//       fileAccess[record.filePath] = (fileAccess[record.filePath] || 0) + 1;
//
//       // æ–‡ä»¶ç±»å‹ç»Ÿè®¡
//       const ext = record.filePath.split('.').pop() || 'unknown';
//       fileTypes[ext] = (fileTypes[ext] || 0) + 1;
//
//       // å°æ—¶è®¿é—®ç»Ÿè®¡
//       const hour = record.timestamp.getHours();
//       const hourKey = `${hour}:00`;
//       hourlyAccess[hourKey] = (hourlyAccess[hourKey] || 0) + 1;
//     });
//
//     const popularFiles = Object.entries(fileAccess)
//       .sort(([, a], [, b]) => b - a)
//       .slice(0, 10)
//       .map(([file, count]) => ({ file, count }));
//
//     return {
//       popularFiles,
//       fileTypes,
//       hourlyAccess
//     };
//   }
//
//   /**
//    * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
//    */
//   private setupGlobalErrorHandler(): void {
//     if (!this.server) {
//       return;
//     }
//
//     const errorHandler: ErrorHandler = (error, req, res, next) => {
//       console.error(`ğŸš¨ [Static Error Handler] ${req.method} ${req.path}: ${error.message}`);
//
//       if (res.isHeadersSent()) {
//         return next(error);
//       }
//
//       res.status(500).json({
//         error: 'Static Server Error',
//         message: error.message,
//         timestamp: new Date().toISOString()
//       });
//     };
//
//     this.server.use(errorHandler);
//   }
//
//   /**
//    * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
//    */
//   private printApiEndpoints(info: ServerInfo): void {
//     const baseUrl = `http://${info.address}:${info.port}`;
//
//     console.log('\nğŸ“ Static File Server APIç«¯ç‚¹:');
//     console.log('='.repeat(50));
//
//     console.log('ğŸ“„ é™æ€æ–‡ä»¶:');
//     console.log(`   GET  ${baseUrl}/                      - é¦–é¡µ`);
//     console.log(`   GET  ${baseUrl}/css/style.css         - CSSæ–‡ä»¶`);
//     console.log(`   GET  ${baseUrl}/js/app.js             - JavaScriptæ–‡ä»¶`);
//     console.log(`   GET  ${baseUrl}/data.json             - JSONæ•°æ®`);
//
//     console.log('\nğŸ“‚ æ–‡ä»¶ç®¡ç†:');
//     console.log(`   GET    ${baseUrl}/api/files           - æ–‡ä»¶æµè§ˆå™¨`);
//     console.log(`   POST   ${baseUrl}/api/upload          - æ–‡ä»¶ä¸Šä¼ `);
//     console.log(`   DELETE ${baseUrl}/api/files/*         - æ–‡ä»¶åˆ é™¤`);
//     console.log(`   GET    ${baseUrl}/api/file-info/*     - æ–‡ä»¶ä¿¡æ¯`);
//
//     console.log('\nğŸ“Š ç»Ÿè®¡åˆ†æ:');
//     console.log(`   GET    ${baseUrl}/api/stats           - è®¿é—®ç»Ÿè®¡`);
//     console.log(`   GET    ${baseUrl}/api/access-log      - è®¿é—®æ—¥å¿—`);
//     console.log(`   DELETE ${baseUrl}/api/access-log      - æ¸…é™¤æ—¥å¿—`);
//
//     console.log('\nâš™ï¸  é…ç½®ç®¡ç†:');
//     console.log(`   GET    ${baseUrl}/api/config          - è·å–é…ç½®`);
//     console.log(`   POST   ${baseUrl}/api/config/cache    - æ›´æ–°ç¼“å­˜é…ç½®`);
//
//     console.log('='.repeat(50));
//   }
// }
