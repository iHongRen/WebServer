/**
 * @fileName : RouterExample.ets
 * @author : @cxy
 * @date : 2025/10/29
 * @description : Routerç¤ºä¾‹ - å±•ç¤ºè·¯ç”±ç³»ç»ŸåŠŸèƒ½
 */

import {
  HttpServer,
  ErrorHandler,
  ServerEventType,
  HttpRequest,
  HttpResponse,
  NextFunction,
} from '@cxy/webserver';
import { socket } from '@kit.NetworkKit';

/**
 * è·¯ç”±é…ç½®æ¥å£
 */
interface RouterConfig {
  port: number;
  staticRoot: string;
  enableLogging: boolean;
  enableCors: boolean;
}

/**
 * è·¯ç”±è®°å½•æ¥å£
 */
interface RouteRecord {
  id: number;
  method: string;
  path: string;
  pattern: string;
  params: Record<string, string>;
  query: string;
  timestamp: Date;
  responseTime: number;
  statusCode: number;
}

/**
 * Routerç¤ºä¾‹ç±»
 * å±•ç¤ºè·¯ç”±ç³»ç»Ÿçš„å„ç§åŠŸèƒ½
 */
export class RouterExample {
  private server: HttpServer | null = null;
  // è·¯ç”±è®°å½•
  private routeRecords: RouteRecord[] = [];
  private nextRouteId: number = 1;
  // åŠ¨æ€è·¯ç”±å­˜å‚¨
  private dynamicRoutes: Map<string, Object> = new Map();

  /**
   * åˆå§‹åŒ–æœåŠ¡å™¨
   */
  public initializeServer(): void {
    this.server = new HttpServer();

    this.setupEventHandling();
    this.setupMiddleware();
    this.setupRoutes();
    this.setupGlobalErrorHandler();
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  public async start(port: number): Promise<socket.NetAddress | null> {
    if (!this.server) {
      this.initializeServer();
    }

    const info = await this.server?.startServer(port);
    if (info) {
      console.log('âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
      console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
      this.printApiEndpoints(info);
      return info;
    } else {
      console.error('âŒ å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:');
      return null;
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  public async stop(): Promise<void> {
    if (this.server) {
      await this.server.stopServer();
    }
  }


  public getRouteCount(): number {
    return this.routeRecords.length;
  }


  /**
   * è®¾ç½®äº‹ä»¶å¤„ç†
   */
  private setupEventHandling(): void {
    if (!this.server) {
      return;
    }

    this.server.onError((error) => {
      console.error(`ğŸš¨ RouteræœåŠ¡å™¨é”™è¯¯ [${error.type}]: ${JSON.stringify(error.error)}`);
    });

    this.server.on(ServerEventType.SERVER_STARTED, (event) => {
      console.log('âœ… RouteræœåŠ¡å™¨å¯åŠ¨æˆåŠŸ:', event.data);
    });
  }

  /**
   * é…ç½®ä¸­é—´ä»¶
   */
  private setupMiddleware(): void {
    if (!this.server) {
      return;
    }

    this.server.logger();
    this.server.cors();

    // è·¯ç”±è®°å½•ä¸­é—´ä»¶
    this.server.use((req: HttpRequest, res: HttpResponse, next: NextFunction) => {
      const startTime = Date.now();

      res.onFinish((statusCode) => {
        const responseTime = Date.now() - startTime;

        const routeRecord: RouteRecord = {
          id: this.nextRouteId++,
          method: req.method,
          path: req.path,
          pattern: req.url,
          params: req.params as Record<string, string>,
          query: JSON.stringify(req.query),
          timestamp: new Date(),
          responseTime,
          statusCode
        };

        this.routeRecords.push(routeRecord);

        // é™åˆ¶è®°å½•æ•°é‡
        if (this.routeRecords.length > 500) {
          this.routeRecords = this.routeRecords.slice(-500);
        }
      });

      next();
    });

    this.server.auto();
  }

  /**
   * é…ç½®è·¯ç”±
   */
  private setupRoutes(): void {
    this.setupBasicRoutes();
    this.setupParameterRoutes();
    this.setupDynamicRoutes();
    this.setupRouteManagement();
  }

  /**
   * åŸºç¡€è·¯ç”±
   */
  private setupBasicRoutes(): void {
    if (!this.server) {
      return;
    }

    // æ ¹è·¯å¾„
    this.server.get('/', (req: HttpRequest, res: HttpResponse) => {
      res.json({
        message: 'Routerç¤ºä¾‹é¦–é¡µ',
        availableRoutes: [
          'GET /',
          'GET /about',
          'GET /contact',
          'GET /api/users/:id',
          'GET /api/products/:category/:id',
          'GET /files/*',
          'POST /api/routes'
        ],
        timestamp: new Date().toISOString()
      });
    });

    // å…³äºé¡µé¢
    this.server.get('/about', (req: HttpRequest, res: HttpResponse) => {
      res.json({
        page: 'About',
        message: 'è¿™æ˜¯å…³äºé¡µé¢',
        version: '1.0.1',
        features: ['åŸºç¡€è·¯ç”±', 'è·¯ç”±å‚æ•°', 'è·¯ç”±ç®¡ç†']
      });
    });

    // è”ç³»é¡µé¢
    this.server.get('/contact', (req: HttpRequest, res: HttpResponse) => {
      res.json({
        page: 'Contact',
        message: 'è”ç³»æˆ‘ä»¬',
        github: 'https://github.com/iHongRen/WebServer'
      });
    });
  }

  /**
   * å‚æ•°è·¯ç”±
   */
  private setupParameterRoutes(): void {
    if (!this.server) {
      return;
    }

    // å•ä¸ªå‚æ•°
    this.server.get('/api/users/:id', (req: HttpRequest, res: HttpResponse) => {
      const userId = req.params['id'];

      res.json({
        route: '/api/users/:id',
        userId,
        name: `User ${userId}`,
        email: `user${userId}@example.com`,
        params: req.params,
        query: JSON.stringify(req.query),
      });
    });

    // å¤šä¸ªå‚æ•°
    this.server.get('/api/products/:category/:id', (req: HttpRequest, res: HttpResponse) => {
      const data = req.params;

      res.json({
        route: '/api/products/:category/:id',
        category: data.category,
        productId: data.id,
        name: `Product ${data.id}`,
        price: Math.floor(Math.random() * 1000) + 100,
        params: req.params as Record<string, string>
      });
    });

    // å¯é€‰å‚æ•°æ¨¡æ‹Ÿ
    this.server.get('/api/posts/:id', (req: HttpRequest, res: HttpResponse) => {
      const postId = req.params['id'];
      const format = req.query.get('format') || 'json';

      const post: Record<string, Object> = {
        'id': postId,
        'title': `Post ${postId}`,
        'content': `This is the content of post ${postId}`,
        'author': 'Admin',
        'createdAt': new Date().toISOString()
      };

      if (format === 'xml') {
        res.setHeader('Content-Type', 'application/xml');
        res.send(`<?xml version="1.0"?>
<post>
  <id>${post.id}</id>
  <title>${post.title}</title>
  <content>${post.content}</content>
  <author>${post.author}</author>
  <createdAt>${post.createdAt}</createdAt>
</post>`);
      } else {
        res.json(post);
      }
    });
  }

  /**
   * åŠ¨æ€è·¯ç”±ç®¡ç†
   */
  private setupDynamicRoutes(): void {
    if (!this.server) {
      return;
    }

    // åŠ¨æ€è·¯ç”±å¤„ç†å™¨
    this.server.use((req: HttpRequest, res: HttpResponse, next: NextFunction) => {
      const routeKey = `${req.method}:${req.path}`;
      const dynamicRoute = this.dynamicRoutes.get(routeKey);

      if (dynamicRoute) {
        res.json({
          message: 'åŠ¨æ€è·¯ç”±å“åº”',
          route: req.path,
          method: req.method,
          config: dynamicRoute,
          timestamp: new Date().toISOString()
        });
      } else {
        next();
      }
    });
  }

  /**
   * è·¯ç”±ç®¡ç†API
   */
  private setupRouteManagement(): void {
    if (!this.server) {
      return;
    }

    // è·å–è·¯ç”±ç»Ÿè®¡
    this.server.get('/api/routes/stats', (req: HttpRequest, res: HttpResponse) => {
      const stats = this.analyzeRouteStats() as Record<string, Object>;

      res.json({
        totalRequests: this.routeRecords.length,
        routeStats: stats.routeStats,
        methodStats: stats.methodStats,
        averageResponseTime: stats.averageResponseTime,
        popularRoutes: stats.popularRoutes,
        recentRequests: this.routeRecords.slice(-10).reverse()
      });
    });

    // è·å–è·¯ç”±è®°å½•
    this.server.get('/api/routes/records', (req: HttpRequest, res: HttpResponse) => {
      const limit = parseInt(req.query.get('limit') || '50');
      const offset = parseInt(req.query.get('offset') || '0');
      const method = req.query.get('method');

      let filteredRecords = this.routeRecords;

      if (method) {
        filteredRecords = filteredRecords.filter(record => record.method === method);
      }

      const records = filteredRecords
        .slice(offset, offset + limit)
        .reverse();

      res.json({
        records,
        total: filteredRecords.length,
        limit,
        offset,
        method
      });
    });

    // æ·»åŠ åŠ¨æ€è·¯ç”±
    this.server.post('/api/routes', (req: HttpRequest, res: HttpResponse) => {
      const method = req.body.method as string
      const path = req.body.path as string
      const response = req.body.response as Object

      if (!method || !path) {
        res.status(400).json({
          error: 'Method and path are required'
        });
        return
      }

      const routeKey = `${method.toUpperCase()}:${path}`;
      this.dynamicRoutes.set(routeKey, {
        'method': method.toUpperCase(),
        'path': path,
        'response': response,
        'createdAt': new Date().toISOString()
      } as Record<string, Object>);

      res.json({
        message: 'Dynamic route added',
        routeKey,
        totalDynamicRoutes: this.dynamicRoutes.size
      });
    });

    // åˆ é™¤åŠ¨æ€è·¯ç”±
    this.server.delete('/api/routes/:method/:path', (req: HttpRequest, res: HttpResponse) => {
      const method = req.params.method
      const path = req.params.path

      const routeKey = `${method.toUpperCase()}:/${path}`;

      const deleted = this.dynamicRoutes.delete(routeKey);

      res.json({
        message: deleted ? 'Dynamic route deleted' : 'Route not found',
        routeKey,
        deleted,
        remainingRoutes: this.dynamicRoutes.size
      });
    });

    // è·å–æ‰€æœ‰åŠ¨æ€è·¯ç”±
    this.server.get('/api/routes/dynamic', (req: HttpRequest, res: HttpResponse) => {
      const routes = Array.from(this.dynamicRoutes)

      res.json({
        dynamicRoutes: routes,
        count: this.dynamicRoutes.size
      });
    });

    // æ¸…é™¤è·¯ç”±è®°å½•
    this.server.delete('/api/routes/records', (req: HttpRequest, res: HttpResponse) => {
      const count = this.routeRecords.length;
      this.routeRecords = [];
      this.nextRouteId = 1;

      res.json({
        message: 'Route records cleared',
        clearedCount: count
      });
    });
  }

  /**
   * åˆ†æè·¯ç”±ç»Ÿè®¡
   */
  private analyzeRouteStats() {
    const routeStats: Record<string, number> = {};
    const methodStats: Record<string, number> = {};
    let totalResponseTime = 0;

    this.routeRecords.forEach(record => {
      const routeKey = `${record.method} ${record.path}`;
      routeStats[routeKey] = (routeStats[routeKey] || 0) + 1;
      methodStats[record.method] = (methodStats[record.method] || 0) + 1;
      totalResponseTime += record.responseTime;
    });

    return {
      'routeStats': routeStats,
      'methodStats': methodStats,
      'averageResponseTime': this.routeRecords.length > 0 ? totalResponseTime / this.routeRecords.length : 0,
    } as Record<string, Object>
  }

  /**
   * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
   */
  private setupGlobalErrorHandler(): void {
    if (!this.server) {
      return;
    }

    const errorHandler: ErrorHandler = (error, req, res, next) => {
      console.error(`ğŸš¨ [Router Error Handler] ${req.method} ${req.path}: ${error.message}`);

      if (res.isHeadersSent()) {
        return next(error);
      }

      res.status(500).json({
        error: 'Router Server Error',
        message: error.message,
        route: req.path,
        method: req.method,
        timestamp: new Date().toISOString()
      });
    };

    this.server.use(errorHandler);
  }

  /**
   * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
   */
  private printApiEndpoints(info: socket.NetAddress): void {
    const baseUrl = `http://${info.address}:${info.port}`;

    console.log('\nğŸ›£ï¸  Router APIç«¯ç‚¹:');
    console.log('='.repeat(50));

    console.log('\nğŸ  åŸºç¡€è·¯ç”±:');
    console.log(`   GET    ${baseUrl}/about               - å…³äºé¡µé¢`);
    console.log(`   GET    ${baseUrl}/contact             - è”ç³»é¡µé¢`);

    console.log('\nğŸ”— å‚æ•°è·¯ç”±:');
    console.log(`   GET    ${baseUrl}/api/users/:id       - ç”¨æˆ·è¯¦æƒ…`);
    console.log(`   GET    ${baseUrl}/api/products/:category/:id - äº§å“è¯¦æƒ…`);
    console.log(`   GET    ${baseUrl}/api/posts/:id       - æ–‡ç« è¯¦æƒ…`);

    console.log('\nâš™ï¸ è·¯ç”±ç®¡ç†:');
    console.log(`   GET    ${baseUrl}/api/routes/stats    - è·¯ç”±ç»Ÿè®¡`);
    console.log(`   GET    ${baseUrl}/api/routes/records  - è·¯ç”±è®°å½•`);
    console.log(`   POST   ${baseUrl}/api/routes          - æ·»åŠ åŠ¨æ€è·¯ç”±`);
    console.log(`   GET    ${baseUrl}/api/routes/dynamic  - è·å–åŠ¨æ€è·¯ç”±`);
    console.log(`   DELETE ${baseUrl}/api/routes/records  - æ¸…é™¤è·¯ç”±è®°å½•`);

    console.log('='.repeat(50));
  }
}