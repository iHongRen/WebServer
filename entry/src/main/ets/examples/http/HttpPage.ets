import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
import { ServerInfo } from '@cxy/webserver';
import { HttpExample } from './HttpExample';

@Builder
function httpBuilder() {
  HttpPage()
}

@Component
struct HttpPage {
  @State title: string = 'HTTPæœåŠ¡å™¨ç¤ºä¾‹'
  @State httpExample: HttpExample | null = null;
  @State serverInfo: ServerInfo | null = null;
  @State isRunning: boolean = false;
  @State port: number = 8080;
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State successMessage: string = '';

  async aboutToAppear() {
    await this.initializeExample();
  }

  aboutToDisappear() {
    this.stopServer();
  }

  /**
   * åˆå§‹åŒ–HTTPç¤ºä¾‹
   */
  async initializeExample() {
    try {
      this.isLoading = true;
      this.errorMessage = '';

      const context = this.getUIContext().getHostContext() as common.UIAbilityContext;

      // åˆ›å»ºHTTPç¤ºä¾‹å®žä¾‹
      this.httpExample = new HttpExample(context, {
        port: this.port,
        enableLogging: true,
        enableCors: true
      });

      // è®¾ç½®é™æ€æ–‡ä»¶
      await this.httpExample.setupStaticFiles();

      // åˆå§‹åŒ–æœåŠ¡å™¨
      this.httpExample.initializeServer();

      this.successMessage = 'âœ… HTTPç¤ºä¾‹åˆå§‹åŒ–å®Œæˆ';
      console.log('HTTPç¤ºä¾‹åˆå§‹åŒ–å®Œæˆ');

    } catch (error) {
      this.errorMessage = `åˆå§‹åŒ–å¤±è´¥: ${error}`;
      console.error('åˆå§‹åŒ–HTTPç¤ºä¾‹å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  async startServer() {
    if (!this.httpExample) {
      await this.initializeExample();
    }

    if (!this.httpExample) {
      this.errorMessage = 'æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥';
      return;
    }

    try {
      this.isLoading = true;
      this.errorMessage = '';

      const info = await this.httpExample.start();

      if (info) {
        this.serverInfo = info;
        this.isRunning = true;
        this.successMessage = `ðŸŸ¢æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼è®¿é—®\n http://${info.address}:${info.port}`;
      } else {
        this.errorMessage = 'æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼ŒæœªèŽ·å–åˆ°åœ°å€';
      }
    } catch (error) {
      const businessError = error as BusinessError;
      this.errorMessage = `å¯åŠ¨å¤±è´¥: ${businessError.message}`;
      console.error('å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  async stopServer() {
    if (!this.httpExample) {
      return;
    }

    try {
      this.isLoading = true;
      await this.httpExample.stop();

      this.isRunning = false;
      this.serverInfo = null;
      this.successMessage = 'ðŸ›‘ æœåŠ¡å™¨å·²åœæ­¢';

    } catch (error) {
      this.errorMessage = `åœæ­¢æœåŠ¡å™¨å¤±è´¥: ${error}`;
      console.error('åœæ­¢æœåŠ¡å™¨å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ›´æ–°ç«¯å£å·
   */
  updatePort(newPort: string) {
    const portNum = parseInt(newPort);
    if (portNum > 0 && portNum <= 65535) {
      this.port = portNum;
      this.errorMessage = '';

      // å¦‚æžœæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–
      if (this.httpExample) {
        this.httpExample = null;
      }
    } else {
      this.errorMessage = 'ç«¯å£å·å¿…é¡»åœ¨1-65535ä¹‹é—´';
    }
  }

  /**
   * æ¸…é™¤æ¶ˆæ¯
   */
  clearMessages() {
    this.errorMessage = '';
    this.successMessage = '';
  }

  build() {
    NavDestination() {
      Column() {
        // æ ‡é¢˜åŒºåŸŸ
        Text(this.title)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 20 })

        // æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
        if (this.errorMessage) {
          Text(this.errorMessage)
            .fontColor(Color.Red)
            .fontSize(14)
            .margin({ bottom: 10 })
            .padding(10)
            .backgroundColor('#ffebee')
            .borderRadius(8)
            .width('90%')
        }

        if (this.successMessage) {
          Text(this.successMessage)
            .fontColor(Color.Green)
            .fontSize(14)
            .margin({ bottom: 10 })
            .padding(10)
            .backgroundColor('#e8f5e8')
            .borderRadius(8)
            .width('90%')
        }

        // æœåŠ¡å™¨çŠ¶æ€åŒºåŸŸ
        if (this.isRunning && this.serverInfo) {
          Column({ space: 15 }) {
            // è¿è¡ŒçŠ¶æ€
            Row() {
              Text('ðŸŸ¢')
                .fontSize(20)
              Text('æœåŠ¡å™¨è¿è¡Œä¸­')
                .fontColor(Color.Green)
                .fontWeight(FontWeight.Bold)
                .fontSize(18)
            }
            .justifyContent(FlexAlign.Center)

            // æœåŠ¡å™¨ä¿¡æ¯å¡ç‰‡
            Column({ space: 10 }) {
              Row() {
                Text('è®¿é—®åœ°å€:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                Text(`http://${this.serverInfo.address}:${this.serverInfo.port}`)
                  .fontColor(Color.Blue)
                  .fontSize(16)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)

              Row() {
                Text('ç«¯å£:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                Text(this.serverInfo.port.toString())
                  .fontSize(16)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)

              Row() {
                Text('é™æ€ç›®å½•:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                Text(this.httpExample?.getConfig().staticRoot || '')
                  .layoutWeight(1)
                  .fontSize(12)
                  .fontColor(Color.Gray)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Top)
            }
            .padding(15)
            .backgroundColor('#f5f5f5')
            .borderRadius(10)
            .width('90%')

            // APIç«¯ç‚¹ä¿¡æ¯
            Column({ space: 8 }) {
              Text('ðŸ“‹ ä¸»è¦APIç«¯ç‚¹')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)
                .margin({ bottom: 5 })

              Text('â€¢ GET /api/users - èŽ·å–ç”¨æˆ·åˆ—è¡¨')
                .fontSize(12)
                .fontColor('#666')
              Text('â€¢ POST /api/users - åˆ›å»ºç”¨æˆ·')
                .fontSize(12)
                .fontColor('#666')
              Text('â€¢ POST /api/upload - æ–‡ä»¶ä¸Šä¼ ')
                .fontSize(12)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .padding(15)
            .backgroundColor('#fff3e0')
            .borderRadius(10)
            .width('90%')

            // åœæ­¢æŒ‰é’®
            Button('åœæ­¢æœåŠ¡å™¨')
              .width('80%')
              .height(50)
              .backgroundColor(Color.Red)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.clearMessages();
                this.stopServer();
              })

          }
          .width('100%')
          .margin({ bottom: 20 })

        } else {
          // æœåŠ¡å™¨æœªè¿è¡ŒçŠ¶æ€
          Column({ space: 20 }) {
            // åœæ­¢çŠ¶æ€
            Row() {
              Text('ðŸ”´')
                .fontSize(20)
              Text('æœåŠ¡å™¨å·²åœæ­¢')
                .fontColor(Color.Red)
                .fontWeight(FontWeight.Bold)
                .fontSize(18)
            }
            .justifyContent(FlexAlign.Center)

            // ç«¯å£é…ç½®
            Column({ space: 10 }) {
              Text('æœåŠ¡å™¨é…ç½®')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)

              Row() {
                Text('ç«¯å£å·:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                TextInput({
                  text: this.port.toString(),
                  placeholder: 'è¯·è¾“å…¥ç«¯å£å· (1-65535)'
                })
                  .type(InputType.Number)
                  .layoutWeight(1)
                  .height(40)
                  .onChange((value) => {
                    this.updatePort(value);
                  })
              }
              .width('100%')
            }
            .padding(15)
            .backgroundColor('#f5f5f5')
            .borderRadius(10)
            .width('90%')

            // åŠŸèƒ½è¯´æ˜Ž
            Column({ space: 8 }) {
              Text('ðŸš€ åŠŸèƒ½ç‰¹æ€§')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)
                .margin({ bottom: 5 })

              Text('âœ… RESTful API (ç”¨æˆ·ç®¡ç†)')
                .fontSize(14)
                .fontColor('#666')
              Text('âœ… æ–‡ä»¶ä¸Šä¼ ä¸‹è½½')
                .fontSize(14)
                .fontColor('#666')
              Text('âœ… é™æ€æ–‡ä»¶æœåŠ¡')
                .fontSize(14)
                .fontColor('#666')
              Text('âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—')
                .fontSize(14)
                .fontColor('#666')
              Text('âœ… CORSè·¨åŸŸæ”¯æŒ')
                .fontSize(14)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .padding(15)
            .backgroundColor('#e3f2fd')
            .borderRadius(10)
            .width('90%')

            // å¯åŠ¨æŒ‰é’®
            Button(this.isLoading ? 'å¯åŠ¨ä¸­...' : 'å¯åŠ¨æœåŠ¡å™¨')
              .width('80%')
              .height(50)
              .backgroundColor(this.isLoading ? Color.Gray : Color.Blue)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.clearMessages();
                this.startServer();
              })
          }
          .width('100%')
        }

        // åŠ è½½æŒ‡ç¤ºå™¨
        if (this.isLoading) {
          Row() {
            LoadingProgress()
              .width(30)
              .height(30)
              .margin({ right: 10 })
            Text('å¤„ç†ä¸­...')
              .fontSize(14)
              .fontColor('#666')
          }
          .margin({ top: 20 })
        }

      }
      .width('100%')
      .height('100%')
      .padding({
        top: 20,
        left: 20,
        right: 20,
        bottom: 20
      })
      .justifyContent(FlexAlign.Start)
    }
    .title(this.title)
    .onReady((ctx) => {
      if (ctx.pathInfo.param) {
        this.title = ctx.pathInfo.param as string;
      }
    })
  }
}

export { httpBuilder }