/**
 * @fileName : BodyPage.ets
 * @author : @cxy
 * @date : 2025/11/2
 * @description : Body Parserç¤ºä¾‹ - å±•ç¤ºå„ç§è¯·æ±‚ä½“è§£æžåŠŸèƒ½
 */

import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
import { ServerInfo } from '@cxy/webserver';
import { BodyParserExample } from './BodyParserExample';

@Builder
function bodyBuilder() {
  BodyPage()
}

@Component
struct BodyPage {
  @State title: string = 'Body Parserç¤ºä¾‹'
  @State bodyParserExample: BodyParserExample | null = null;
  @State serverInfo: ServerInfo | null = null;
  @State port: number = 8082;
  @State errorMessage: string = '';
  @State successMessage: string = '';
  @State parseResultCount: number = 0;

  aboutToAppear() {
    setTimeout(() => {
      this.startServer();
    }, 0);
  }

  aboutToDisappear() {
    this.stopServer();
  }

  /**
   * åˆå§‹åŒ–Body Parserç¤ºä¾‹
   */
  async initializeExample() {
    this.errorMessage = '';
    this.bodyParserExample = new BodyParserExample();
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  async startServer() {
    if (!this.bodyParserExample) {
      await this.initializeExample();
    }

    if (!this.bodyParserExample) {
      this.errorMessage = 'Body ParseræœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥';
      return;
    }

    try {
      this.errorMessage = '';

      const info = await this.bodyParserExample.start(this.port);

      if (info) {
        this.serverInfo = info;
        this.successMessage = `ðŸ”§ Body ParseræœåŠ¡å™¨è¿è¡Œä¸­`;
        this.startStatsUpdate();
      } else {
        this.errorMessage = 'Body ParseræœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼ŒæœªèŽ·å–åˆ°åœ°å€';
      }
    } catch (error) {
      const businessError = error as BusinessError;
      this.errorMessage = `å¯åŠ¨å¤±è´¥: ${businessError.message}`;
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  async stopServer() {
    if (!this.bodyParserExample) {
      return;
    }

    try {
      await this.bodyParserExample.stop();

      this.bodyParserExample = null;
      this.serverInfo = null;
      this.successMessage = 'ðŸ”§ Body ParseræœåŠ¡å™¨å·²åœæ­¢';
      this.parseResultCount = 0;

    } catch (error) {
      this.errorMessage = `åœæ­¢æœåŠ¡å™¨å¤±è´¥: ${error}`;
    }
  }

  /**
   * å¯åŠ¨ç»Ÿè®¡æ•°æ®æ›´æ–°
   */
  startStatsUpdate() {
    const updateStats = () => {
      if (this.bodyParserExample) {
        this.parseResultCount = this.bodyParserExample.getParseResultCount();
      }
    };

    updateStats();
    setInterval(updateStats, 3000);
  }

  /**
   * æ›´æ–°ç«¯å£å·
   */
  updatePort(newPort: string) {
    const portNum = parseInt(newPort);
    if (portNum > 0 && portNum <= 65535) {
      this.port = portNum;
      this.errorMessage = '';
    } else {
      this.errorMessage = 'ç«¯å£å·å¿…é¡»åœ¨1-65535ä¹‹é—´';
    }
  }

  /**
   * æ¸…é™¤æ¶ˆæ¯
   */
  clearMessages() {
    this.errorMessage = '';
    this.successMessage = '';
  }

  build() {
    NavDestination() {
      Column() {
        // æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
        if (this.errorMessage) {
          Text(this.errorMessage)
            .fontColor(Color.Red)
            .fontSize(14)
            .margin({ bottom: 10 })
            .padding(10)
            .backgroundColor('#ffebee')
            .borderRadius(8)
            .width('90%')
            .textAlign(TextAlign.Center)
        } else if (this.successMessage) {
          Text(this.successMessage)
            .fontColor(Color.Green)
            .fontSize(14)
            .margin({ bottom: 10 })
            .padding(10)
            .backgroundColor('#e8f5e8')
            .borderRadius(8)
            .width('90%')
            .textAlign(TextAlign.Center)
        }

        // æœåŠ¡å™¨çŠ¶æ€åŒºåŸŸ
        if (this.serverInfo) {
          Column({ space: 15 }) {
            // æœåŠ¡å™¨ä¿¡æ¯å¡ç‰‡
            Column({ space: 10 }) {
              Row() {
                Text('ðŸ”§ æœåŠ¡åœ°å€:')
                  .fontWeight(FontWeight.Medium)
                  .width(100)
                Text(`http://${this.serverInfo.address}:${this.serverInfo.port}`)
                  .fontColor(Color.Blue)
                  .fontSize(16)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)

              Row() {
                Text('æ¼”ç¤ºé¡µé¢:')
                  .fontWeight(FontWeight.Medium)
                  .width(100)
                Text(`/body-parser-demo.html`)
                  .fontSize(14)
                  .fontColor(Color.Blue)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
            }
            .padding(15)
            .backgroundColor('#f0f8ff')
            .borderRadius(10)
            .width('90%')

            // è§£æžç»Ÿè®¡
            Column({ space: 10 }) {
              Text('ðŸ“Š è§£æžç»Ÿè®¡')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)
                .margin({ bottom: 5 })

              Row() {
                Text('è§£æžæ¬¡æ•°:')
                  .fontWeight(FontWeight.Medium)
                  .width(80)
                Text(this.parseResultCount.toString())
                  .fontSize(16)
                  .fontColor(Color.Blue)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
            }
            .padding(15)
            .backgroundColor('#f0fff0')
            .borderRadius(10)
            .width('90%')

            // è§£æžå™¨ç±»åž‹
            Column({ space: 8 }) {
              Text('ðŸ”§ æ”¯æŒçš„è§£æžå™¨')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)
                .margin({ bottom: 5 })

              Text('âœ… JSON Parser (application/json)')
                .fontSize(12)
                .fontColor('#666')
              Text('âœ… URL-Encoded Parser (form data)')
                .fontSize(12)
                .fontColor('#666')
              Text('âœ… Multipart Parser (file upload)')
                .fontSize(12)
                .fontColor('#666')
              Text('âœ… Plain Text Parser (text/plain)')
                .fontSize(12)
                .fontColor('#666')
              Text('âœ… Auto Parser (æ™ºèƒ½è¯†åˆ«)')
                .fontSize(12)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .padding(15)
            .backgroundColor('#fff3e0')
            .borderRadius(10)
            .width('90%')

            // åœæ­¢æŒ‰é’®
            Button('åœæ­¢Body ParseræœåŠ¡å™¨')
              .width('80%')
              .height(50)
              .backgroundColor('#d32f2f')
              .onClick(() => {
                this.clearMessages();
                this.stopServer();
              })
          }
          .width('100%')

        } else {
          // æœåŠ¡å™¨æœªè¿è¡ŒçŠ¶æ€
          Column({ space: 20 }) {
            // é…ç½®åŒºåŸŸ
            Row() {
              Text('ç«¯å£å·:')
                .fontWeight(FontWeight.Medium)
                .width(80)
              TextInput({
                text: this.port.toString(),
                placeholder: 'è¯·è¾“å…¥ç«¯å£å· (1-65535)'
              })
                .type(InputType.Number)
                .layoutWeight(1)
                .height(40)
                .onChange((value) => {
                  this.updatePort(value);
                })
            }
            .padding(15)
            .backgroundColor('#f5f5f5')
            .borderRadius(10)
            .width('90%')

            // åŠŸèƒ½è¯´æ˜Ž
            Column({ space: 8 }) {
              Text('ðŸ”§ Body ParseråŠŸèƒ½')
                .fontWeight(FontWeight.Bold)
                .fontSize(16)
                .margin({ bottom: 5 })

              Text('ðŸ“ JSONæ•°æ®è§£æž')
                .fontSize(14)
                .fontColor('#666')
              Text('ðŸ“‹ è¡¨å•æ•°æ®è§£æž')
                .fontSize(14)
                .fontColor('#666')
              Text('ðŸ“ æ–‡ä»¶ä¸Šä¼ è§£æž')
                .fontSize(14)
                .fontColor('#666')
              Text('ðŸ“„ çº¯æ–‡æœ¬è§£æž')
                .fontSize(14)
                .fontColor('#666')
              Text('ðŸ¤– æ™ºèƒ½è‡ªåŠ¨è§£æž')
                .fontSize(14)
                .fontColor('#666')
              Text('ðŸ“Š è§£æžç»“æžœç»Ÿè®¡')
                .fontSize(14)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .padding(15)
            .backgroundColor('#e3f2fd')
            .borderRadius(10)
            .width('90%')

            // å¯åŠ¨æŒ‰é’®
            Button('å¯åŠ¨Body ParseræœåŠ¡å™¨')
              .width('80%')
              .height(50)
              .backgroundColor('#1976d2')
              .onClick(() => {
                this.clearMessages();
                this.startServer();
              })
          }
          .width('100%')
        }
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .justifyContent(FlexAlign.Start)
    }
    .title(this.title)
    .onReady((ctx) => {
      if (ctx.pathInfo.param) {
        this.title = ctx.pathInfo.param as string;
      }
    })
  }
}

