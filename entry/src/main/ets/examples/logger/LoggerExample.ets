// /**
//  * @fileName : LoggerExample.ets
//  * @author : @cxy
//  * @date : 2025/10/29
//  * @description : Loggerç¤ºä¾‹ - å±•ç¤ºæ—¥å¿—è®°å½•åŠŸèƒ½
//  */
//
// import { fileIo } from '@kit.CoreFileKit';
// import { common } from '@kit.AbilityKit';
// import {
//   HttpServer,
//   ErrorHandler,
//   ServerInfo,
//   ServerEventType,
//   HttpRequest,
//   HttpResponse,
//   NextFunction,
// } from '@cxy/webserver';
// import { util } from '@kit.ArkTS';
//
// /**
//  * æ—¥å¿—é…ç½®æ¥å£
//  */
// interface LoggerConfig {
//   port: number;
//   staticRoot: string;
//   enableCors: boolean;
//   logFormat: 'dev' | 'combined' | 'common' | 'short' | 'tiny';
//   logLevel: 'debug' | 'info' | 'warn' | 'error';
//   logToFile: boolean;
//   logFilePath: string;
// }
//
// /**
//  * æ—¥å¿—è®°å½•æ¥å£
//  */
// interface LogRecord {
//   id: number;
//   timestamp: Date;
//   level: 'debug' | 'info' | 'warn' | 'error';
//   method: string;
//   url: string;
//   statusCode: number;
//   responseTime: number;
//   userAgent: string;
//   ip: string;
//   message: string;
// }
//
// /**
//  * Loggerç¤ºä¾‹ç±»
//  * å±•ç¤ºå„ç§æ—¥å¿—è®°å½•åŠŸèƒ½å’Œæ ¼å¼
//  */
// export class LoggerExample {
//   private server: HttpServer | null = null;
//   private serverInfo: ServerInfo | null = null;
//   private isRunning: boolean = false;
//   private config: LoggerConfig;
//   private context: common.UIAbilityContext;
//   // æ—¥å¿—è®°å½•
//   private logRecords: LogRecord[] = [];
//   private nextLogId: number = 1;
//
//   constructor(context: common.UIAbilityContext, config?: Partial<LoggerConfig>) {
//     this.context = context;
//     this.config = {
//       port: config?.port || 8085,
//       staticRoot: config?.staticRoot || context.filesDir + '/static',
//       enableCors: config?.enableCors || true,
//       logFormat: config?.logFormat || 'dev',
//       logLevel: config?.logLevel || 'info',
//       logToFile: config?.logToFile || true,
//       logFilePath: config?.logFilePath || context.filesDir + '/server.log',
//     };
//   }
//
//   /**
//    * è®¾ç½®é™æ€æ–‡ä»¶
//    */
//   public async setupStaticFiles(): Promise<void> {
//     const access = await fileIo.access(this.config.staticRoot);
//     if (!access) {
//       await fileIo.mkdir(this.config.staticRoot);
//     }
//
//     await this.copyStaticFile('logger-demo.html');
//     await this.copyStaticFile('log-viewer.html');
//   }
//
//   /**
//    * åˆå§‹åŒ–æœåŠ¡å™¨
//    */
//   public initializeServer(): void {
//     this.server = new HttpServer();
//
//     this.setupEventHandling();
//     this.setupMiddleware();
//     this.setupRoutes();
//     this.setupGlobalErrorHandler();
//   }
//
//   /**
//    * å¯åŠ¨æœåŠ¡å™¨
//    */
//   public async start(): Promise<ServerInfo | null> {
//     try {
//       if (!this.server) {
//         this.initializeServer();
//       }
//
//       if (!this.server) {
//         throw new Error('LoggeræœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥');
//       }
//
//       const info = await this.server.startServer(this.config.port);
//
//       if (info.address) {
//         this.serverInfo = info;
//         this.isRunning = true;
//
//         console.log('âœ… LoggeræœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
//         console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
//         this.printApiEndpoints(info);
//
//         return info;
//       } else {
//         throw new Error('æœªèƒ½è·å–æœåŠ¡å™¨åœ°å€');
//       }
//     } catch (error) {
//       console.error('âŒ å¯åŠ¨LoggeræœåŠ¡å™¨å¤±è´¥:', error);
//       this.isRunning = false;
//       return null;
//     }
//   }
//
//   /**
//    * åœæ­¢æœåŠ¡å™¨
//    */
//   public async stop(): Promise<void> {
//     if (this.server && this.isRunning) {
//       await this.server.stopServer();
//       this.isRunning = false;
//       this.serverInfo = null;
//       console.log('ğŸ›‘ LoggeræœåŠ¡å™¨å·²åœæ­¢');
//     }
//   }
//
//   // Getteræ–¹æ³•
//   public getServerInfo(): ServerInfo | null {
//     return this.serverInfo;
//   }
//
//   public getIsRunning(): boolean {
//     return this.isRunning;
//   }
//
//   public getConfig(): LoggerConfig {
//     return this.config;
//   }
//
//   public getLogCount(): number {
//     return this.logRecords.length;
//   }
//
//   /**
//    * å¤åˆ¶é™æ€æ–‡ä»¶
//    */
//   private async copyStaticFile(fileName: string): Promise<void> {
//     try {
//       const buffer = await this.context.resourceManager.getRawFileContent(fileName);
//       const filePath = `${this.config.staticRoot}/${fileName}`;
//
//       const file = await fileIo.open(filePath,
//         fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.TRUNC);
//       await fileIo.write(file.fd, buffer.buffer);
//       await fileIo.close(file.fd);
//     } catch (error) {
//       console.warn(`âš ï¸  æ— æ³•å¤åˆ¶æ–‡ä»¶ ${fileName}:`, error);
//     }
//   }
//
//   /**
//    * è®¾ç½®äº‹ä»¶å¤„ç†
//    */
//   private setupEventHandling(): void {
//     if (!this.server) {
//       return;
//     }
//
//     this.server.onError((error) => {
//       this.writeLog('error', `æœåŠ¡å™¨é”™è¯¯: ${JSON.stringify(error)}`, {
//         errorType: error.type
//       });
//     });
//
//     this.server.on(ServerEventType.SERVER_STARTED, (event) => {
//       this.writeLog('info', 'æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ', event.data);
//     });
//
//     this.server.on(ServerEventType.SERVER_STOPPED, () => {
//       this.writeLog('info', 'æœåŠ¡å™¨å·²åœæ­¢');
//     });
//   }
//
//   /**
//    * é…ç½®ä¸­é—´ä»¶
//    */
//   private setupMiddleware(): void {
//     if (!this.server) {
//       return;
//     }
//
//     if (this.config.enableCors) {
//       this.server.cors({ origin: '*' });
//     }
//
//     // è‡ªå®šä¹‰æ—¥å¿—ä¸­é—´ä»¶
//     this.server.use((req: HttpRequest, res: HttpResponse, next: NextFunction) => {
//       const startTime = Date.now();
//
//       // è®°å½•è¯·æ±‚å¼€å§‹
//       this.writeLog('debug', `è¯·æ±‚å¼€å§‹: ${req.method} ${req.path}`, {
//         method: req.method,
//         url: req.path,
//         userAgent: req.userAgent,
//         ip: req.ip
//       });
//
//       // ç›‘å¬å“åº”å®Œæˆ
//       res.onFinish((statusCode, responseSize) => {
//         const responseTime = Date.now() - startTime;
//
//         // è®°å½•è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—
//         const logRecord: LogRecord = {
//           id: this.nextLogId++,
//           timestamp: new Date(),
//           level: statusCode >= 400 ? 'error' : statusCode >= 300 ? 'warn' : 'info',
//           method: req.method,
//           url: req.url,
//           statusCode,
//           responseTime,
//           userAgent: req.userAgent,
//           ip: req.ip,
//           message: this.formatLogMessage(req, statusCode, responseTime, responseSize)
//         };
//
//         this.logRecords.push(logRecord);
//
//         // é™åˆ¶æ—¥å¿—è®°å½•æ•°é‡
//         if (this.logRecords.length > 1000) {
//           this.logRecords = this.logRecords.slice(-1000);
//         }
//
//         // å†™å…¥æ–‡ä»¶æ—¥å¿—
//         if (this.config.logToFile) {
//           this.writeToFile(logRecord);
//         }
//
//         console.log(`ğŸ“ ${logRecord.message}`);
//       });
//
//       next();
//     });
//
//     this.server.auto();
//     this.server.serveStatic(this.config.staticRoot);
//   }
//
//   /**
//    * æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
//    */
//   private formatLogMessage(req: HttpRequest, statusCode: number, responseTime: number, responseSize: number): string {
//     const timestamp = new Date().toISOString();
//
//     switch (this.config.logFormat) {
//       case 'combined':
//         return `${req.ip} - - [${timestamp}] "${req.method} ${req.url} HTTP/1.1" ${statusCode} ${responseSize} "${req.referer}" "${req.userAgent}"`;
//
//       case 'common':
//         return `${req.ip} - - [${timestamp}] "${req.method} ${req.url} HTTP/1.1" ${statusCode} ${responseSize}`;
//
//       case 'short':
//         return `${req.ip} ${req.method} ${req.url} HTTP/1.1 ${statusCode} ${responseSize} - ${responseTime}ms`;
//
//       case 'tiny':
//         return `${req.method} ${req.url} ${statusCode} ${responseSize} - ${responseTime}ms`;
//
//       case 'dev':
//       default:
//         const statusColor = statusCode >= 400 ? 'ğŸ”´' : statusCode >= 300 ? 'ğŸŸ¡' : 'ğŸŸ¢';
//         return `${statusColor} ${req.method} ${req.url} ${statusCode} ${responseTime}ms - ${responseSize}b`;
//     }
//   }
//
//   /**
//    * å†™å…¥æ—¥å¿—
//    */
//   private writeLog(level: 'debug' | 'info' | 'warn' | 'error', message: string, data?: ESObject): void {
//     const logLevels = {
//       'debug': 0,
//       'info': 1,
//       'warn': 2,
//       'error': 3
//     } as Record<string, number>
//     const configLevel = logLevels[this.config.logLevel];
//     const messageLevel = logLevels[level];
//
//     if (messageLevel >= configLevel) {
//       const timestamp = new Date().toISOString();
//       const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
//
//       if (data) {
//         console.log(logMessage, data);
//       } else {
//         console.log(logMessage);
//       }
//
//       if (this.config.logToFile) {
//         this.writeToFile({
//           id: this.nextLogId++,
//           timestamp: new Date(),
//           level,
//           method: '',
//           url: '',
//           statusCode: 0,
//           responseTime: 0,
//           userAgent: '',
//           ip: '',
//           message: logMessage
//         });
//       }
//     }
//   }
//
//   /**
//    * å†™å…¥æ–‡ä»¶æ—¥å¿—
//    */
//   private async writeToFile(logRecord: LogRecord): Promise<void> {
//     try {
//       const logLine = `${logRecord.message}\n`;
//       const file = await fileIo.open(this.config.logFilePath,
//         fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.APPEND);
//       await fileIo.write(file.fd, new util.TextEncoder().encode(logLine).buffer);
//       await fileIo.close(file.fd);
//     } catch (error) {
//       console.error('å†™å…¥æ—¥å¿—æ–‡ä»¶å¤±è´¥:', error);
//     }
//   }
//
//   /**
//    * é…ç½®è·¯ç”±
//    */
//   private setupRoutes(): void {
//     this.setupLogRoutes();
//     this.setupConfigRoutes();
//     this.setupTestRoutes();
//   }
//
//   /**
//    * æ—¥å¿—æŸ¥è¯¢è·¯ç”±
//    */
//   private setupLogRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // è·å–æ—¥å¿—è®°å½•
//     this.server.get('/api/logs', (req: HttpRequest, res: HttpResponse) => {
//       const limit = parseInt(req.query.get('limit') || '50');
//       const offset = parseInt(req.query.get('offset') || '0');
//       const level = req.query.get('level');
//       const method = req.query.get('method');
//
//       let filteredLogs = this.logRecords;
//
//       if (level) {
//         filteredLogs = filteredLogs.filter(log => log.level === level);
//       }
//
//       if (method) {
//         filteredLogs = filteredLogs.filter(log => log.method === method);
//       }
//
//       const logs = filteredLogs
//         .slice(offset, offset + limit)
//         .reverse();
//
//       res.json({
//         logs,
//         total: filteredLogs.length,
//         limit,
//         offset,
//         filters: { level, method } as ESObject
//       });
//     });
//
//     // è·å–æ—¥å¿—ç»Ÿè®¡
//     this.server.get('/api/logs/stats', (req: HttpRequest, res: HttpResponse) => {
//       const stats = this.analyzeLogStats();
//
//       res.json({
//         totalLogs: this.logRecords.length,
//         byLevel: stats.byLevel,
//         byMethod: stats.byMethod,
//         byStatusCode: stats.byStatusCode,
//         averageResponseTime: stats.averageResponseTime,
//         errorRate: stats.errorRate
//       });
//     });
//
//     // æ¸…é™¤æ—¥å¿—è®°å½•
//     this.server.delete('/api/logs', (req: HttpRequest, res: HttpResponse) => {
//       const count = this.logRecords.length;
//       this.logRecords = [];
//       this.nextLogId = 1;
//
//       res.json({
//         message: 'Log records cleared',
//         clearedCount: count
//       });
//     });
//   }
//
//   /**
//    * é…ç½®ç®¡ç†è·¯ç”±
//    */
//   private setupConfigRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // è·å–æ—¥å¿—é…ç½®
//     this.server.get('/api/logs/config', (req: HttpRequest, res: HttpResponse) => {
//       res.json({
//         config: this.config,
//         availableFormats: ['dev', 'combined', 'common', 'short', 'tiny'],
//         availableLevels: ['debug', 'info', 'warn', 'error']
//       });
//     });
//
//     // æ›´æ–°æ—¥å¿—é…ç½®
//     this.server.post('/api/logs/config', (req: HttpRequest, res: HttpResponse) => {
//       const data = req.body as Record<string, string>;
//
//       // if (data.logFormat) {
//       //   this.config.logFormat = data.logFormat;
//       // }
//       // if (data.logLevel) {
//       //   this.config.logLevel = data.logLevel;
//       // }
//       // if (data.logToFile !== undefined) {
//       //   this.config.logToFile = data.logToFile;
//       // }
//       //
//       // this.writeLog('info', 'æ—¥å¿—é…ç½®å·²æ›´æ–°', {
//       //   newFormat: this.config.logFormat,
//       //   newLevel: this.config.logLevel,
//       //   fileLogging: this.config.logToFile
//       // });
//
//       res.json({
//         message: 'Logger configuration updated',
//         config: this.config
//       });
//     });
//   }
//
//   /**
//    * æµ‹è¯•è·¯ç”±
//    */
//   private setupTestRoutes(): void {
//     if (!this.server) {
//       return;
//     }
//
//     // æµ‹è¯•ä¸åŒçº§åˆ«çš„æ—¥å¿—
//     this.server.post('/api/logs/test/:level', (req: HttpRequest, res: HttpResponse) => {
//       const level = req.params['level'] as 'debug' | 'info' | 'warn' | 'error';
//       const message = `æµ‹è¯•${level}çº§åˆ«æ—¥å¿—`;
//
//       this.writeLog(level, message, {
//         testData: req.body,
//         triggeredBy: 'api'
//       });
//
//       res.json({
//         message: `${level} log generated`,
//         logLevel: level,
//         timestamp: new Date().toISOString()
//       });
//     });
//
//     // æ¨¡æ‹Ÿæ…¢è¯·æ±‚
//     this.server.get('/api/test/slow', (req: HttpRequest, res: HttpResponse) => {
//       const delay = parseInt(req.query.get('delay') || '1000');
//
//       setTimeout(() => {
//         res.json({
//           message: 'Slow request completed',
//           delay,
//           timestamp: new Date().toISOString()
//         });
//       }, delay);
//     });
//
//     // æ¨¡æ‹Ÿé”™è¯¯è¯·æ±‚
//     this.server.get('/api/test/error/:code', (req: HttpRequest, res: HttpResponse) => {
//       const statusCode = parseInt(req.params['code']);
//
//       res.status(statusCode).json({
//         error: `Simulated ${statusCode} error`,
//         timestamp: new Date().toISOString()
//       });
//     });
//   }
//
//   /**
//    * åˆ†ææ—¥å¿—ç»Ÿè®¡
//    */
//   private analyzeLogStats(): ESObject {
//     const byLevel: Record<string, number> = {};
//     const byMethod: Record<string, number> = {};
//     const byStatusCode: Record<string, number> = {};
//     let totalResponseTime = 0;
//     let errorCount = 0;
//
//     this.logRecords.forEach(log => {
//       byLevel[log.level] = (byLevel[log.level] || 0) + 1;
//       byMethod[log.method] = (byMethod[log.method] || 0) + 1;
//       byStatusCode[log.statusCode] = (byStatusCode[log.statusCode] || 0) + 1;
//
//       totalResponseTime += log.responseTime;
//
//       if (log.statusCode >= 400) {
//         errorCount++;
//       }
//     });
//
//     return {
//       byLevel,
//       byMethod,
//       byStatusCode,
//       averageResponseTime: this.logRecords.length > 0 ? totalResponseTime / this.logRecords.length : 0,
//       errorRate: this.logRecords.length > 0 ? (errorCount / this.logRecords.length) * 100 : 0
//     } as ESObject;
//   }
//
//   /**
//    * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
//    */
//   private setupGlobalErrorHandler(): void {
//     if (!this.server) {
//       return;
//     }
//
//     const errorHandler: ErrorHandler = (error, req, res, next) => {
//       this.writeLog('error', `å…¨å±€é”™è¯¯å¤„ç†: ${error.message}`, {
//         path: req.path,
//         method: req.method,
//         error: error.message
//       });
//
//       if (res.isHeadersSent()) {
//         return next(error);
//       }
//
//       res.status(500).json({
//         error: 'Logger Server Error',
//         message: error.message,
//         timestamp: new Date().toISOString()
//       });
//     };
//
//     this.server.use(errorHandler);
//   }
//
//   /**
//    * æ‰“å°APIç«¯ç‚¹ä¿¡æ¯
//    */
//   private printApiEndpoints(info: ServerInfo): void {
//     const baseUrl = `http://${info.address}:${info.port}`;
//
//     console.log('\nğŸ“ Logger APIç«¯ç‚¹:');
//     console.log('='.repeat(50));
//
//     console.log('ğŸ“„ æ¼”ç¤ºé¡µé¢:');
//     console.log(`   GET  ${baseUrl}/logger-demo.html       - Loggeræ¼”ç¤ºé¡µé¢`);
//     console.log(`   GET  ${baseUrl}/log-viewer.html        - æ—¥å¿—æŸ¥çœ‹å™¨`);
//
//     console.log('\nğŸ“Š æ—¥å¿—æŸ¥è¯¢:');
//     console.log(`   GET    ${baseUrl}/api/logs             - è·å–æ—¥å¿—è®°å½•`);
//     console.log(`   GET    ${baseUrl}/api/logs/stats       - è·å–æ—¥å¿—ç»Ÿè®¡`);
//     console.log(`   DELETE ${baseUrl}/api/logs             - æ¸…é™¤æ—¥å¿—è®°å½•`);
//
//     console.log('\nâš™ï¸  æ—¥å¿—é…ç½®:');
//     console.log(`   GET    ${baseUrl}/api/logs/config      - è·å–æ—¥å¿—é…ç½®`);
//     console.log(`   POST   ${baseUrl}/api/logs/config      - æ›´æ–°æ—¥å¿—é…ç½®`);
//
//     console.log('\nğŸ§ª æ—¥å¿—æµ‹è¯•:');
//     console.log(`   POST   ${baseUrl}/api/logs/test/:level - æµ‹è¯•æ—¥å¿—çº§åˆ«`);
//     console.log(`   GET    ${baseUrl}/api/test/slow        - æ…¢è¯·æ±‚æµ‹è¯•`);
//     console.log(`   GET    ${baseUrl}/api/test/error/:code - é”™è¯¯è¯·æ±‚æµ‹è¯•`);
//
//     console.log('='.repeat(50));
//   }
// }