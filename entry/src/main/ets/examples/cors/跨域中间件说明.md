# CORS (跨域资源共享) 中间件使用指南

## 1. 概述

### 1.1. 什么是 CORS?

CORS (Cross-Origin Resource Sharing) 是一种基于 HTTP 头的机制，它允许服务器指定哪些源 (domain, scheme, or port) 可以访问其资源。当一个 Web 应用向一个与其自身源不同的服务器请求资源时，就会产生“跨域请求”。出于安全原因，浏览器会限制这种跨域请求。

CORS 中间件可以帮助你的服务器正确地设置必要的 HTTP 头，从而安全地允许或拒绝这些跨域请求。

### 1.2. 简单请求 vs. 预检请求 (Preflight)

浏览器将 CORS 请求分为两类：

1.  **简单请求 (Simple Requests)**:
    *   必须是 `GET`, `HEAD`, `POST` 方法之一。
    *   HTTP 头只能包含一些安全字段，如 `Accept`, `Accept-Language`, `Content-Language`, `Content-Type` (仅限于 `application/x-www-form-urlencoded`, `multipart/form-data`, `text/plain`)。
    *   对于简单请求，浏览器直接发送请求，并在响应头中检查 `Access-Control-Allow-Origin`。

2.  **预检请求 (Preflighted Requests)**:
    *   当请求不满足“简单请求”的条件时，例如使用了 `PUT`, `DELETE` 等方法，或者包含了 `Content-Type: application/json`、自定义头（如 `Authorization`）等，浏览器会首先发送一个 `OPTIONS` 方法的“预检”请求。
    *   服务器需要正确响应这个 `OPTIONS` 请求，告知浏览器实际请求是否被允许。如果预检通过，浏览器才会发送实际的请求。
    *   CORS 中间件会自动处理这个 `OPTIONS` 预检请求。

## 2. 如何使用

在 `WebServer` 中，你可以通过 `server.cors()` 方法来启用和配置 CORS 中间件。

### 2.1. 快速开始 (允许所有源)

最简单的配置是允许来自任何源的跨域请求。这对于公共 API 很有用。

```typescript
import { HttpServer } from "@cxy/webserver";

const server = new HttpServer();

// 启用 CORS，允许所有源
server.cors();

server.get('/api/public-data', (req, res) => {
  res.json({ message: '此数据可以从任何地方访问' });
});

server.startServer(8083);
```

### 2.2. 自定义配置

对于大多数应用，你需要更精细的控制，例如只允许来自你的前端应用的请求。

```typescript
import { HttpServer } from "@cxy/webserver";

const server = new HttpServer();

server.cors({
  origin: 'https://my-frontend-app.com', // 只允许来自这个源的请求
  methods: ['GET', 'POST', 'PUT', 'DELETE'], // 允许的方法
  allowedHeaders: ['Content-Type', 'Authorization'], // 允许的自定义头
  credentials: true // 允许发送 cookie 等凭证
});

server.get('/api/user-data', (req, res) => {
  // ... 处理请求 ...
});

server.startServer(8083);
```

## 3. 配置选项详解

`server.cors(options)` 的 `options` 对象可以包含以下字段：

-   `origin`: `string | string[] | boolean | ((origin: string) => boolean)`
    *   **`string`**: 指定一个允许的源，例如 `'https://example.com'`。
    *   **`string[]`**: 指定一个允许的源列表，例如 `['http://localhost:3000', 'https://dev.myapp.com']`。
    *   **`boolean`**: 设置为 `true` 等同于 `'*'`，允许所有源。
    *   **`function`**: 一个函数，接收请求的 `origin` 头作为参数，返回 `true` (允许) 或 `false` (拒绝)。
-   `methods`: `string | string[]` - 允许的 HTTP 方法列表。默认为 `['GET', 'HEAD', 'PUT', 'PATCH', 'POST', 'DELETE']`。
-   `allowedHeaders`: `string | string[]` - 在预检请求中，服务器允许的请求头列表。
-   `exposedHeaders`: `string | string[]` - 设置 `Access-Control-Expose-Headers` 响应头，指定哪些头可以被浏览器端的脚本访问。
-   `credentials`: `boolean` - 设置 `Access-Control-Allow-Credentials` 响应头。如果设为 `true`，浏览器将允许在跨域请求中发送 cookies 和其他凭证。
-   `maxAge`: `number` - 设置 `Access-Control-Max-Age` 响应头，指定预检请求结果可以被缓存的时间（秒）。

## 4. API 测试示例 (`curl`)

以下 `curl` 命令可以用来测试本示例中运行的 CORS 服务器。请将 `http://your-ip:8083` 替换为你的实际地址。

### 4.1. 测试简单请求 (`/api/cors/simple`)

这是一个简单的 GET 请求，不需要预检。

```bash
# 模拟来自一个允许的源的请求
curl -X GET http://your-ip:8083/api/cors/simple \
  -H "Origin: http://any-origin.com" \
  -v
```
**预期响应头**: `Access-Control-Allow-Origin: *` (或你配置的源)

### 4.2. 测试预检请求 (`/api/cors/preflight`)

这个 `POST` 请求带有 `application/json` 类型和自定义头，会触发预检。

```bash
# 1. 浏览器发送 OPTIONS 预检请求
curl -X OPTIONS http://your-ip:8083/api/cors/preflight \
  -H "Origin: http://any-origin.com" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -v

# 2. 如果预检成功，浏览器发送实际的 POST 请求
curl -X POST http://your-ip:8083/api/cors/preflight \
  -H "Origin: http://any-origin.com" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer some-token" \
  -d '{"user": "cxy"}'
```
**预期响应**: 预检请求会返回 `Access-Control-Allow-Methods` 和 `Access-Control-Allow-Headers` 等头。

### 4.3. 测试来源被拒绝

如果服务器配置了特定的 `origin`，来自其他源的请求将被拒绝。

```bash
# 假设服务器配置为只允许 'https://my-app.com'
# 这个来自 'https://disallowed.com' 的请求将被浏览器阻止
curl -X GET http://your-ip:8083/api/cors/simple \
  -H "Origin: https://disallowed.com" \
  -v
```
**预期**: 响应中**不会**包含 `Access-Control-Allow-Origin` 头，浏览器控制台会报告 CORS 错误。