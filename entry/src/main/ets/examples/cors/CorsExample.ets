/**
 * @fileName : CorsExample.ets
 * @author : @cxy
 * @date : 2025/10/29
 * @description : CORSç¤ºä¾‹ - å±•ç¤ºè·¨åŸŸèµ„æºå…±äº«åŠŸèƒ½
 */

import {
  HttpServer, HttpRequest, HttpResponse, NextFunction,
} from '@cxy/webserver';
import { socket } from '@kit.NetworkKit';

/**
 * CORSé…ç½®æ¥å£ï¼Œç”¨äºå®šä¹‰æœåŠ¡å™¨çš„CORSç­–ç•¥å’Œè¡Œä¸º
 */
interface CorsConfig {
  corsOrigins: string[]; // å…è®¸çš„æ¥æº
  corsMethods: string[]; // å…è®¸çš„HTTPæ–¹æ³•
  corsHeaders: string[]; // å…è®¸çš„è¯·æ±‚å¤´
  corsCredentials: boolean; // æ˜¯å¦æ”¯æŒå‡­è¯
}

interface CorsRequests {
  id: number;
  origin: string;
  method: string;
  headers: string[];
  allowed: boolean;
  timestamp: Date;
}

/**
 * CORSç¤ºä¾‹ç±»
 * å°è£…äº†ç”¨äºæ¼”ç¤ºCORSåŠŸèƒ½çš„HttpServerå®ä¾‹
 */
export class CorsExample {
  private server: HttpServer | null = null;
  private config: CorsConfig;
  // ç”¨äºå­˜å‚¨å’Œç»Ÿè®¡CORSè¯·æ±‚
  private corsRequests: Array<CorsRequests> = [];
  private nextId: number = 1;

  constructor() {
    this.config = {
      corsOrigins: ['*'],
      corsMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
      corsHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
      corsCredentials: true,
    };
  }


  /**
   * åˆå§‹åŒ–æœåŠ¡å™¨ï¼Œè®¾ç½®äº‹ä»¶ç›‘å¬ã€ä¸­é—´ä»¶å’Œè·¯ç”±
   */
  public initializeServer(): void {
    this.server = new HttpServer();

    this.setupMiddleware();
    this.setupRoutes();
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  public async start(port: number): Promise<socket.NetAddress | null> {
    try {
      if (!this.server) {
        this.initializeServer();
      }

      if (!this.server) {
        throw new Error('CORSæœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥');
      }

      const info = await this.server.startServer(port);

      if (info.address) {
        console.log('âœ… CORSæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');
        console.log(`ğŸŒ è®¿é—®åœ°å€: http://${info.address}:${info.port}`);
        this.printApiEndpoints(info);

        return info;
      } else {
        throw new Error('æœªèƒ½è·å–æœåŠ¡å™¨åœ°å€');
      }
    } catch (error) {
      console.error('âŒ å¯åŠ¨CORSæœåŠ¡å™¨å¤±è´¥:', error);
      return null;
    }
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  public async stop(): Promise<void> {
    if (this.server) {
      await this.server.stopServer();
      console.log('ğŸ›‘ CORSæœåŠ¡å™¨å·²åœæ­¢');
    }
  }


  public getCorsRequestCount(): number {
    return this.corsRequests.length;
  }


  /**
   * é…ç½®ä¸­é—´ä»¶
   */
  private setupMiddleware(): void {
    if (!this.server) {
      return;
    }

    // 1. æ—¥å¿—ä¸­é—´ä»¶
    this.server.logger({
      format: 'dev',
      stream: (log: string) => console.log(`ğŸŒ ${log}`)
    });

    // 2. è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼Œç”¨äºåœ¨CORSå¤„ç†å‰è®°å½•æ‰€æœ‰ä¼ å…¥çš„è·¨åŸŸè¯·æ±‚
    this.server.use((req: HttpRequest, res: HttpResponse, next: NextFunction) => {
      const origin = req.get('origin') || req.get('referer') || 'unknown';
      const method = req.method;
      const requestedHeaders = req.get('access-control-request-headers')?.split(',') || [];

      // è®°å½•CORSè¯·æ±‚ï¼Œç”¨äºç»Ÿè®¡å’Œåˆ†æ
      const corsRequest: CorsRequests = {
        id: this.nextId++,
        origin,
        method,
        headers: requestedHeaders,
        allowed: this.isOriginAllowed(origin), // æ£€æŸ¥æ¥æºæ˜¯å¦åœ¨ç™½åå•ä¸­
        timestamp: new Date()
      };
      this.corsRequests.push(corsRequest);

      console.log(`ğŸŒ CORSè¯·æ±‚: ${method} from ${origin} - ${corsRequest.allowed ? 'âœ… å…è®¸' : 'âŒ æ‹’ç»'}`);

      next(); // å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    });

    // 3. æ ¸å¿ƒCORSä¸­é—´ä»¶
    this.server.cors({
      origin: this.config.corsOrigins,
      methods: this.config.corsMethods,
      allowedHeaders: this.config.corsHeaders
    });

    // 4. å…¶ä»–ä¸­é—´ä»¶
    this.server.auto(); // è‡ªåŠ¨è§£æè¯·æ±‚ä½“
  }

  /**
   * æ£€æŸ¥ç»™å®šçš„ origin æ˜¯å¦åœ¨å…è®¸çš„åˆ—è¡¨ä¸­
   */
  private isOriginAllowed(origin: string): boolean {
    if (this.config.corsOrigins.includes('*')) {
      return true;
    }
    return this.config.corsOrigins.some(allowed =>
    origin.includes(allowed) || allowed.includes(origin)
    );
  }

  /**
   * é›†ä¸­é…ç½®æ‰€æœ‰è·¯ç”±
   */
  private setupRoutes(): void {
    this.setupCorsTestRoutes();
    this.setupCorsConfigRoutes();
  }

  /**
   * CORSæµ‹è¯•è·¯ç”±ï¼Œç”¨äºæ¼”ç¤ºä¸åŒç±»å‹çš„CORSè¯·æ±‚
   */
  private setupCorsTestRoutes(): void {
    if (!this.server) {
      return;
    }

    // ç”¨äºæµ‹è¯•ç®€å•è¯·æ±‚ (e.g., GET)
    this.server.get('/api/cors/simple', (req: HttpRequest, res: HttpResponse) => {
      const origin = req.get('origin') || 'unknown';

      res.json({
        message: 'CORSç®€å•è¯·æ±‚æµ‹è¯•æˆåŠŸ',
        origin,
        method: req.method,
        timestamp: new Date().toISOString(),
        corsType: 'Simple Request'
      });
    });

    // ç”¨äºæµ‹è¯•éœ€è¦é¢„æ£€çš„è¯·æ±‚ (e.g., POST with custom headers)
    this.server.post('/api/cors/preflight', (req: HttpRequest, res: HttpResponse) => {
      const origin = req.get('origin') || 'unknown';

      res.json({
        message: 'CORSé¢„æ£€è¯·æ±‚æµ‹è¯•æˆåŠŸ',
        origin,
        method: req.method,
        body: req.body,
        timestamp: new Date().toISOString(),
        corsType: 'Preflight Request'
      });
    });

    // ç”¨äºæµ‹è¯•å¸¦å‡­è¯çš„è¯·æ±‚ (e.g., with cookies)
    this.server.post('/api/cors/credentials', (req: HttpRequest, res: HttpResponse) => {
      const origin = req.get('origin') || 'unknown';
      const cookies = req.get('cookie') || 'none';

      // è®¾ç½®ä¸€ä¸ªæµ‹è¯•cookieä»¥ä¾›å®¢æˆ·ç«¯æ¥æ”¶
      res.setHeader('Set-Cookie', 'cors-test=success; Path=/; HttpOnly');

      res.json({
        message: 'CORSå‡­è¯è¯·æ±‚æµ‹è¯•æˆåŠŸ',
        origin,
        cookies,
        credentialsSupported: this.config.corsCredentials,
        timestamp: new Date().toISOString(),
        corsType: 'Credentialed Request'
      });
    });

    // ç”¨äºæµ‹è¯•å¸¦è‡ªå®šä¹‰è¯·æ±‚å¤´çš„è¯·æ±‚
    this.server.put('/api/cors/custom-headers', (req: HttpRequest, res: HttpResponse) => {
      const origin = req.get('origin') || 'unknown';
      const customHeader = req.get('x-custom-header') || 'none';
      const authorization = req.get('authorization') || 'none';

      res.json({
        message: 'CORSè‡ªå®šä¹‰å¤´éƒ¨æµ‹è¯•æˆåŠŸ',
        origin,
        customHeader,
        authorization,
        allowedHeaders: this.config.corsHeaders,
        timestamp: new Date().toISOString(),
        corsType: 'Custom Headers Request'
      });
    });
  }

  /**
   * CORSé…ç½®ç®¡ç†è·¯ç”±
   */
  private setupCorsConfigRoutes(): void {
    if (!this.server) {
      return;
    }


    // è·å–å½“å‰CORSé…ç½®
    this.server.get('/api/cors/config', (req: HttpRequest, res: HttpResponse) => {
      res.json({
        corsConfig: {
          'origins': this.config.corsOrigins,
          'methods': this.config.corsMethods,
          'headers': this.config.corsHeaders,
          'credentials': this.config.corsCredentials
        } as Record<string, Object>,
        description: {
          'origins': 'Allowed origins for CORS requests',
          'methods': 'Allowed HTTP methods',
          'headers': 'Allowed request headers',
          'credentials': 'Whether credentials are supported'
        } as Record<string, Object>
      });
    });


    // æµ‹è¯•ç‰¹å®šæ¥æºæ˜¯å¦è¢«å…è®¸
    this.server.post('/api/cors/test-origin', (req: HttpRequest, res: HttpResponse) => {
      const body = req.body as Record<string, string>;
      const allowed = this.isOriginAllowed(body.testOrigin);

      res.json({
        origin: body.testOrigin,
        allowed,
        reason: allowed ? 'Origin is in allowed list' : 'Origin not in allowed list',
        allowedOrigins: this.config.corsOrigins
      });
    });
  }


  /**
   * åœ¨æ§åˆ¶å°æ‰“å°æ‰€æœ‰å¯ç”¨çš„APIç«¯ç‚¹å’Œæµ‹è¯•ä¿¡æ¯
   */
  private printApiEndpoints(info: socket.NetAddress): void {
    const baseUrl = `http://${info.address}:${info.port}`;

    console.log('\nğŸŒ CORS APIç«¯ç‚¹:');
    console.log('='.repeat(60));

    console.log('\nğŸ§ª CORSæµ‹è¯• API:');
    console.log(`   GET    ${baseUrl}/api/cors/simple       (ç®€å•è¯·æ±‚)`);
    console.log(`   POST   ${baseUrl}/api/cors/preflight    (é¢„æ£€è¯·æ±‚)`);
    console.log(`   POST   ${baseUrl}/api/cors/credentials  (å‡­è¯è¯·æ±‚)`);
    console.log(`   PUT    ${baseUrl}/api/cors/custom-headers (è‡ªå®šä¹‰å¤´éƒ¨)`);

    console.log('\nâš™ï¸  CORSé…ç½® API:');
    console.log(`   GET    ${baseUrl}/api/cors/config       (è·å–é…ç½®)`);
    console.log(`   POST   ${baseUrl}/api/cors/test-origin  (æµ‹è¯•æ¥æº)`);

    console.log('\nğŸš€ æµ‹è¯•å‘½ä»¤:');
    console.log(`   sh ./test-cors.sh`);
    console.log('='.repeat(60));
  }
}